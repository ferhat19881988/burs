<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fenomen Eğitim Kurumları - Sınav Başvuru Sistemi</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --primary:#1f2a37;
      --secondary:#e74c3c;
      --accent:#3498db;
      --muted:#6b7280;
      --bg:#f6f7fb;
    }
    * { box-sizing: border-box; }
    body{
      font-family:'Poppins', sans-serif;
      background: radial-gradient(1200px 800px at 20% 10%, rgba(52,152,219,0.10), transparent 60%),
                  radial-gradient(900px 650px at 85% 20%, rgba(231,76,60,0.10), transparent 55%),
                  var(--bg);
      color:#111827;
    }
    .main-container{
      max-width:1100px;
      margin:40px auto;
      background:#fff;
      border-radius:18px;
      box-shadow:0 14px 50px rgba(17,24,39,0.12);
      padding:28px;
      min-height:80vh;
    }
    .brand-title{
      letter-spacing:.2px;
      line-height:1.15;
    }
    .brand-sub{ color:var(--muted); }
    .btn-big{
      height:130px;
      font-size:1.35rem;
      display:flex;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      border-radius:16px;
      transition:transform .2s ease, box-shadow .2s ease;
    }
    .btn-big:hover{
      transform:translateY(-4px);
      box-shadow:0 10px 25px rgba(17,24,39,0.14);
    }

    /* Wizard */
    .wizard-step{ display:none; animation:fadeIn .35s ease; }
    .wizard-step.active{ display:block; }
    @keyframes fadeIn { from{opacity:0; transform:translateY(10px);} to{opacity:1; transform:translateY(0);} }

    .step-pill{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:10px 14px;
      border-radius:999px;
      background:#f3f4f6;
      color:#111827;
      font-weight:600;
      font-size:.95rem;
    }

    .section-card{
      border:1px solid rgba(17,24,39,0.08);
      border-radius:16px;
      overflow:hidden;
      box-shadow:0 8px 20px rgba(17,24,39,0.06);
    }
    .section-card .section-head{
      background:linear-gradient(135deg, rgba(52,152,219,0.14), rgba(231,76,60,0.10));
      padding:14px 16px;
      border-bottom:1px solid rgba(17,24,39,0.08);
    }

    .exam-card-selection{
      cursor:pointer;
      border:2px solid rgba(17,24,39,0.10);
      border-radius:14px;
      transition:transform .15s ease, box-shadow .15s ease, border-color .15s ease, background .15s ease;
      height:100%;
    }
    .exam-card-selection:hover{
      transform:translateY(-2px);
      box-shadow:0 8px 20px rgba(17,24,39,0.10);
      border-color:rgba(52,152,219,0.55);
      background:rgba(52,152,219,0.05);
    }
    .exam-card-selection.selected{
      border-color:var(--accent);
      background:rgba(52,152,219,0.07);
    }
    .disabled-option{
      opacity:.55;
      pointer-events:none;
      background:#f3f4f6;
    }

    .soft-divider{ border-top:1px dashed rgba(17,24,39,0.20); margin:14px 0; }
    .hint{ color:var(--muted); font-size:.92rem; }

    /* Student card */
    .student-card{
      width: 360px;
      height: 210px;
      border-radius: 16px;
      border: 1px solid rgba(17,24,39,0.18);
      background:
        radial-gradient(700px 240px at 0% 0%, rgba(52,152,219,0.18), transparent 60%),
        radial-gradient(700px 260px at 100% 100%, rgba(231,76,60,0.14), transparent 55%),
        #ffffff;
      box-shadow:0 10px 30px rgba(17,24,39,0.12);
      padding:14px;
      position:relative;
      overflow:hidden;
      page-break-inside: avoid;
    }
    .student-card .card-top{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      padding-bottom:10px;
      border-bottom:1px solid rgba(17,24,39,0.12);
      margin-bottom:10px;
    }
    .student-card .card-title{
      font-size:14px;
      font-weight:800;
      text-transform:uppercase;
      letter-spacing:.5px;
      color:var(--primary);
      margin:0;
    }
    .student-card .card-sub{
      font-size:11px;
      color:var(--muted);
      margin:2px 0 0 0;
    }
    .badge-chip{
      border-radius:999px;
      padding:6px 10px;
      font-size:11px;
      font-weight:700;
      border:1px solid rgba(17,24,39,0.12);
      background:rgba(255,255,255,0.7);
      backdrop-filter: blur(6px);
      white-space:nowrap;
    }

    .card-info{
      font-size:12px;
      line-height:1.35;
      display:grid;
      grid-template-columns: 110px 1fr;
      gap:6px 10px;
    }
    .card-label{ font-weight:700; color:#111827; }
    .card-value{ color:#111827; }

    .watermark{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      transform:rotate(-22deg);
      font-size:28px;
      font-weight:800;
      color:rgba(231,76,60,0.16);
      pointer-events:none;
      white-space:nowrap;
    }

    /* Print */
    @media print{
      body *{ visibility:hidden; }
      #print-area, #print-area *{ visibility:visible; }
      #print-area{ position:absolute; left:0; top:0; width:100%; padding:0; margin:0; }
      .no-print{ display:none !important; }

      .print-grid{
        display:grid;
        grid-template-columns: 1fr 1fr;
        gap: 8mm 6mm;
        padding: 10mm;
      }
      .student-card{
        width: 90mm;
        height: 55mm;
        box-shadow:none !important;
        border:1px solid #000 !important;
      }
      .student-card .card-title{ font-size:12px; }
      .student-card .card-sub{ font-size:10px; }
      .card-info{ font-size:10px; grid-template-columns: 35mm 1fr; }
    }
  </style>
</head>

<body>
  <div class="container main-container">
    <div class="text-center mb-4">
      <h2 class="fw-bold brand-title m-0">
        <i class="fas fa-graduation-cap text-danger"></i> Fenomen Eğitim Kurumları
      </h2>
      <p class="brand-sub m-0 mt-2">Bursluluk ve LGS Provası Başvuru Sistemi</p>
    </div>

    <!-- MENU -->
    <div id="menu-section" class="row g-4">
      <div class="col-md-4">
        <button class="btn btn-outline-primary btn-big w-100" onclick="app.navTo('new-registration')">
          <i class="fas fa-user-plus fa-2x mb-2"></i>
          Yeni Kayıt
        </button>
      </div>
      <div class="col-md-4">
        <button class="btn btn-outline-success btn-big w-100" onclick="app.navTo('check-registration')">
          <i class="fas fa-search fa-2x mb-2"></i>
          Kayıtlı Bilgisi
        </button>
      </div>
      <div class="col-md-4">
        <button class="btn btn-outline-dark btn-big w-100" onclick="app.navTo('admin-login')">
          <i class="fas fa-user-shield fa-2x mb-2"></i>
          Yönetici Bölümü
        </button>
      </div>
    </div>

    <!-- NEW REGISTRATION -->
    <div id="new-registration" class="d-none">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="d-flex flex-column">
          <h4 class="m-0"><i class="fas fa-file-signature"></i> Yeni Sınav Kaydı</h4>
          <div class="hint mt-1">Adımları takip ederek başvurunuzu tamamlayabilirsiniz.</div>
        </div>
        <div class="d-flex gap-2">
          <button class="btn btn-sm btn-outline-secondary" onclick="app.goHome()"><i class="fa-solid fa-house"></i> Ana Menü</button>
        </div>
      </div>

      <div id="step-1" class="wizard-step active">
        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
          <span class="step-pill"><i class="fa-solid fa-1"></i> Sınav ve Seans Seçimi</span>
          <div class="d-flex gap-2">
            <button id="btn-back-to-exams" class="btn btn-sm btn-outline-primary d-none" onclick="app.backToExamGroups()">
              <i class="fa-solid fa-arrow-left"></i> Sınavlara Dön
            </button>
            <button class="btn btn-sm btn-outline-secondary" onclick="app.resetWizard()"><i class="fa-solid fa-rotate-right"></i> Yenile</button>
          </div>
        </div>

        <div class="section-card">
          <div class="section-head d-flex justify-content-between align-items-center">
            <div>
              <div class="fw-bold">Seçim</div>
              <div class="hint" id="step1-subtitle">Lütfen bir sınav seçiniz.</div>
            </div>
            <div class="d-flex align-items-center gap-2">
              <div id="exam-list-loader" class="d-flex align-items-center gap-2">
                <div class="spinner-border spinner-border-sm text-primary"></div>
                <span class="hint">Yükleniyor...</span>
              </div>
            </div>
          </div>
          <div class="p-3">
            <div id="exam-groups-container" class="row g-3"></div>
            <div id="sessions-container" class="row g-3 d-none"></div>
          </div>
        </div>
      </div>

      <div id="step-2" class="wizard-step">
        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
          <span class="step-pill"><i class="fa-solid fa-2"></i> Onay</span>
          <button class="btn btn-sm btn-outline-secondary" onclick="app.goToStep(1)"><i class="fa-solid fa-arrow-left"></i> Geri</button>
        </div>

        <div class="alert alert-warning border-0 shadow-sm" style="border-radius:16px;">
          <div class="d-flex gap-3 align-items-start">
            <div class="pt-1"><i class="fa-solid fa-circle-question fa-2x text-warning"></i></div>
            <div class="flex-grow-1">
              <h4 class="alert-heading mb-2">Seçim Onayı</h4>
              <div id="confirm-text" class="lead mb-3"></div>
              <div class="soft-divider"></div>
              <div class="d-flex flex-wrap gap-2">
                <button class="btn btn-outline-danger btn-lg" onclick="app.resetWizard()"><i class="fa-solid fa-xmark"></i> Hayır, İptal</button>
                <button class="btn btn-success btn-lg" onclick="app.goToStep(3)"><i class="fa-solid fa-check"></i> Evet, Devam Et</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="step-3" class="wizard-step">
        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
          <span class="step-pill"><i class="fa-solid fa-3"></i> Kimlik Kontrolü</span>
          <button class="btn btn-sm btn-outline-secondary" onclick="app.goToStep(2)"><i class="fa-solid fa-arrow-left"></i> Geri</button>
        </div>

        <div class="row">
          <div class="col-md-7 col-lg-6 mx-auto">
            <div class="section-card">
              <div class="section-head">
                <div class="fw-bold">TC Kimlik Numaranız</div>
                <div class="hint">11 haneli TC numaranızı girerek kayıt durumunuzu kontrol edelim.</div>
              </div>
              <div class="p-3">
                <label class="form-label">TC Kimlik No</label>
                <input type="text" id="reg-tc-check" class="form-control form-control-lg text-center" placeholder="___________" inputmode="numeric">
                <button class="btn btn-primary w-100 mt-3" onclick="app.checkTCStatus()">
                  <i class="fa-solid fa-magnifying-glass"></i> Sorgula ve Devam Et
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="step-4" class="wizard-step">
        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
          <span class="step-pill"><i class="fa-solid fa-4"></i> Öğrenci Bilgileri</span>
          <button class="btn btn-sm btn-outline-secondary" onclick="app.goToStep(3)"><i class="fa-solid fa-arrow-left"></i> Geri</button>
        </div>

        <form id="student-form" onsubmit="return false;">
          <div class="section-card">
            <div class="section-head">
              <div class="fw-bold">Bilgileri Doldurunuz</div>
              <div class="hint">Zorunlu alanları eksiksiz doldurunuz. Ad/Soyad alanları en az 2 kelime olmalıdır.</div>
            </div>
            <div class="p-3">
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">Öğrenci Tam Adı (Ad Soyad)</label>
                  <input type="text" id="form-student-name" class="form-control" placeholder="Örn: Ali Yılmaz" required>
                  <div class="form-text">En az 2 kelime olmalıdır.</div>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Okulu</label>
                  <input type="text" id="form-school" class="form-control" required>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Veli Tam Adı</label>
                  <input type="text" id="form-parent-name" class="form-control" placeholder="Örn: Ayşe Yılmaz" required>
                  <div class="form-text">En az 2 kelime olmalıdır.</div>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Telefon 1 (İletişim)</label>
                  <input type="text" id="form-phone1" class="form-control phone-mask" placeholder="(5__) ___ __ __" required>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Telefon 2 (Yedek)</label>
                  <input type="text" id="form-phone2" class="form-control phone-mask" placeholder="(5__) ___ __ __">
                  <div class="form-text text-danger">Bilgilendirme telefon üzerinden yapılacaktır, lütfen doğru giriniz.</div>
                </div>
              </div>

              <div class="d-flex justify-content-end mt-4">
                <button class="btn btn-success btn-lg" onclick="app.submitRegistration()">
                  <i class="fa-solid fa-floppy-disk"></i> Kaydı Tamamla
                </button>
              </div>
            </div>
          </div>
        </form>
      </div>

      <div id="step-5" class="wizard-step text-center">
        <div class="alert alert-success border-0 shadow-sm" style="border-radius:16px;">
          <i class="fas fa-check-circle fa-3x"></i>
          <h4 class="mt-2 mb-1">Başvurunuz Alınmıştır!</h4>
          <p class="m-0">Giriş kartınız basıma geçilmiştir. Sınavdan 2 gün önce kurumdan teslim alabilirsiniz.</p>
        </div>

        <div class="d-flex justify-content-center mt-3" id="final-card-preview"></div>
        <div class="mt-2">
          <small class="text-danger fw-bold">* Bu ekrandaki kart örnektir, resmi giriş belgesi yerine geçmez. Baskı alınamaz.</small>
        </div>
        <div class="mt-4 d-flex justify-content-center gap-2 flex-wrap">
          <button class="btn btn-outline-primary" onclick="app.resetWizard()"><i class="fa-solid fa-plus"></i> Yeni Başvuru</button>
          <button class="btn btn-outline-secondary" onclick="app.goHome()"><i class="fa-solid fa-house"></i> Ana Menü</button>
        </div>
      </div>
    </div>

    <!-- CHECK REGISTRATION -->
    <div id="check-registration" class="d-none">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
          <h4 class="m-0"><i class="fas fa-search"></i> Başvuru Sorgulama</h4>
          <div class="hint mt-1">TC Kimlik No veya Öğrenci No ile sorgulayabilirsiniz.</div>
        </div>
        <button class="btn btn-sm btn-outline-secondary" onclick="app.goHome()"><i class="fa-solid fa-house"></i> Ana Menü</button>
      </div>

      <div class="row">
        <div class="col-lg-7 mx-auto">
          <div class="input-group">
            <input type="text" id="search-query" class="form-control form-control-lg" placeholder="TC Kimlik No veya Öğrenci No">
            <button class="btn btn-primary btn-lg" onclick="app.searchStudent()"><i class="fa-solid fa-magnifying-glass"></i> Sorgula</button>
          </div>
          <div class="form-text">TC Kimlik No 11 hane olmalıdır. Öğrenci No yalnızca rakam olmalıdır.</div>
        </div>
      </div>

      <div id="search-results" class="mt-4"></div>
    </div>

    <!-- ADMIN LOGIN -->
    <div id="admin-login" class="d-none">
      <div class="row">
        <div class="col-md-5 col-lg-4 mx-auto mt-4">
          <div class="section-card text-center">
            <div class="section-head">
              <div class="fw-bold"><i class="fa-solid fa-lock"></i> Yönetici Girişi</div>
              <div class="hint">Yetkili kullanıcılar için.</div>
            </div>
            <div class="p-3">
              <input type="password" id="admin-pass" class="form-control form-control-lg text-center" placeholder="Şifre">
              <button class="btn btn-dark w-100 mt-3" onclick="app.checkAdmin()"><i class="fa-solid fa-right-to-bracket"></i> Giriş</button>
              <button class="btn btn-link mt-2" onclick="app.goHome()">İptal</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ADMIN PANEL -->
    <div id="admin-panel" class="d-none">
      <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
        <div>
          <h4 class="text-danger m-0"><i class="fa-solid fa-user-shield"></i> Yönetici Paneli</h4>
          <div class="hint mt-1">Kayıtlar, filtreleme, çıktı alma ve toplu işlemler.</div>
        </div>
        <div class="d-flex gap-2">
          <button class="btn btn-outline-secondary btn-sm" onclick="app.adminRefresh()"><i class="fa-solid fa-rotate"></i> Yenile</button>
          <button class="btn btn-outline-dark btn-sm" onclick="app.goHome()"><i class="fa-solid fa-right-from-bracket"></i> Çıkış</button>
        </div>
      </div>

      <div class="card p-3 mb-3 bg-light" style="border-radius:16px;">
        <div class="row g-2 align-items-end">
          <div class="col-md-3">
            <label class="form-label mb-1">Sınav</label>
            <select id="admin-filter-exam" class="form-select" onchange="app.adminLoadData()">
              <option value="">Tüm Sınavlar</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label mb-1">Seans Saati</label>
            <select id="admin-filter-session" class="form-select" onchange="app.adminLoadData()">
              <option value="">Tüm Seanslar</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label mb-1">Arama</label>
            <div class="input-group">
              <input type="text" id="admin-search" class="form-control" placeholder="Ad Soyad / TC / Öğr No" oninput="app.adminLoadData()">
              <button class="btn btn-outline-secondary" onclick="document.getElementById('admin-search').value=''; app.adminLoadData();"><i class="fa-solid fa-xmark"></i></button>
            </div>
          </div>
          <div class="col-md-2 text-end">
            <button class="btn btn-primary w-100" onclick="app.openQuickReg()"><i class="fas fa-plus"></i> Hızlı Kayıt</button>
          </div>
        </div>

        <div class="soft-divider"></div>

        <div class="d-flex justify-content-end gap-2 flex-wrap">
          <button class="btn btn-outline-primary btn-sm" onclick="app.adminPrintList()"><i class="fas fa-list"></i> Yoklama Listesi</button>
          <button class="btn btn-outline-success btn-sm" onclick="app.adminPrintBatchCards()"><i class="fas fa-id-card"></i> Toplu Kart Bas</button>
          <button class="btn btn-outline-danger btn-sm" onclick="app.adminBatchDelete()"><i class="fas fa-trash"></i> Toplu Sil</button>
        </div>
      </div>

      <div class="table-responsive">
        <table class="table table-hover table-bordered bg-white align-middle">
          <thead class="table-dark">
            <tr>
              <th style="width:42px;"><input type="checkbox" id="select-all" onclick="app.toggleSelectAll()"></th>
              <th>Öğr No</th>
              <th>TC No</th>
              <th>Ad Soyad</th>
              <th>Okul</th>
              <th>Veli</th>
              <th>Telefon</th>
              <th>Sınav / Tarih / Seans</th>
              <th style="width:130px;">İşlemler</th>
            </tr>
          </thead>
          <tbody id="admin-table-body"></tbody>
        </table>
      </div>
      <div class="hint mt-2">Not: Kart baskıları A4 üzerine 2 sütun düzeniyle kartvizit boyutunda hazırlanır.</div>
    </div>
  </div>

  <!-- Cancel Modal -->
  <div class="modal fade" id="cancelModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content" style="border-radius:16px;">
        <div class="modal-header bg-danger text-white" style="border-top-left-radius:16px;border-top-right-radius:16px;">
          <h5 class="modal-title"><i class="fa-solid fa-triangle-exclamation"></i> Sınav İptal Onayı</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p class="mb-2">
            Kaydı silmek için lütfen aşağıdaki kutuya <strong>"<span id="cancel-name-target"></span> sınav iptal"</strong> yazınız.
          </p>
          <input type="text" id="cancel-confirm-input" class="form-control" placeholder="Doğrulama metnini giriniz">
          <div class="form-text text-danger">Bu işlem geri alınamaz. Silinen kayıt kadar kontenjan tekrar açılır.</div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Kapat</button>
          <button type="button" class="btn btn-danger" onclick="app.confirmCancellation()"><i class="fa-solid fa-trash"></i> Onayla ve Sil</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Quick Reg Modal -->
  <div class="modal fade" id="quickRegModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content" style="border-radius:16px;">
        <div class="modal-header" style="border-top-left-radius:16px;border-top-right-radius:16px;">
          <h5 class="modal-title"><i class="fa-solid fa-bolt"></i> Hızlı Öğrenci Kaydı</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="quick-reg-body"></div>
      </div>
    </div>
  </div>

  <div id="print-area"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.inputmask/5.0.8/jquery.inputmask.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getDatabase, ref, set, push, get, child, remove, update, runTransaction } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAIzu6aNQstwQCdMWODyIwiaVVBm63OeGw",
      authDomain: "odevfeno.firebaseapp.com",
      databaseURL: "https://odevfeno-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "odevfeno",
      storageBucket: "odevfeno.firebasestorage.app",
      messagingSenderId: "662757516934",
      appId: "1:662757516934:web:0042188832f63deb6fd307",
      measurementId: "G-4Q99NQRB38"
    };

    const firebaseApp = initializeApp(firebaseConfig);
    const db = getDatabase(firebaseApp);

    const normalizeTR = (s) => (s || "")
      .toString()
      .trim()
      .replace(/\\s+/g, " ")
      .toLocaleLowerCase("tr-TR");

    const maskTC = (tc) => {
      if (!tc || tc.length !== 11) return tc || "";
      return tc.substring(0,2) + "*****" + tc.substring(9);
    };

    const isDigits = (s) => /^[0-9]+$/.test((s || "").toString());
    const nowISO = () => new Date().toISOString();

    window.app = {
      sheetUrl: "https://docs.google.com/spreadsheets/d/1oJGMO7FOPV4U86peeA63lmMk-wVCKsfWuyw2yefMweg/export?format=csv",
      db: db,
      dbRef: ref(db),

      examsData: [],
      examGroups: [],
      selectedGroupId: null,
      selectedSession: null,

      adminDataCache: [],
      currentUserToDelete: null,

      init: function () {
        $(".phone-mask").inputmask("(599) 999 99 99", { "placeholder": "_" });
        $("#reg-tc-check").inputmask("99999999999", { "placeholder": "_" });
        $("#search-query").inputmask("99999999999", { "placeholder": "_" });
        this.fetchExams();
      },

      navTo: function (screenId) {
        document.querySelectorAll(".main-container > div[id]").forEach(el => el.classList.add("d-none"));
        document.getElementById("menu-section").classList.add("d-none");
        document.getElementById(screenId).classList.remove("d-none");
        if (screenId === "new-registration") this.resetWizard();
        if (screenId === "admin-login") document.getElementById("admin-pass").value = "";
      },

      goHome: function () {
        document.querySelectorAll(".main-container > div[id]").forEach(el => el.classList.add("d-none"));
        document.getElementById("menu-section").classList.remove("d-none");
        this.selectedGroupId = null;
        this.selectedSession = null;
      },

      fetchExams: function () {
        Papa.parse(this.sheetUrl, {
          download: true,
          header: true,
          complete: (results) => this.processSheetData(results.data || []),
          error: (err) => {
            console.error("Sheet Error:", err);
            Swal.fire({ icon: "error", title: "Hata", text: "Sınav bilgileri alınamadı. Lütfen daha sonra tekrar deneyiniz." });
          }
        });
      },

      processSheetData: function (data) {
        this.examsData = [];
        this.examGroups = [];

        data.forEach((row, index) => {
          const examName = (row["Sınav"] || "").trim();
          const tarihRaw = (row["Tarih"] || "").trim();
          const kontRaw = (row["Kontenjan"] || "").trim();
          const saatRaw = (row["Saatler"] || "").trim();
          const startNum = parseInt((row["İlk numara"] || "").toString().trim(), 10);
          if (!examName || !tarihRaw || !saatRaw || !kontRaw) return;

          const dates = tarihRaw.split(";").map(s => s.trim()).filter(Boolean);
          const quotas = kontRaw.split(";").map(s => s.trim()).filter(Boolean);
          const hours = saatRaw.split(";").map(s => s.trim()).filter(Boolean);

          const groupId = `grp_${index}`;
          const group = { groupId, baseRowIndex: index, name: examName, startNum: Number.isFinite(startNum) ? startNum : 1000, sessions: [] };

          hours.forEach((h, i) => {
            const uniqueId = `exam_${index}_sess_${i}`;
            const session = {
              id: uniqueId,
              groupId,
              baseRowIndex: index,
              name: examName,
              date: dates[i] || dates[0] || "",
              time: h,
              quota: parseInt(quotas[i] || quotas[0] || "0", 10) || 0,
              startNum: group.startNum
            };
            this.examsData.push(session);
            group.sessions.push(session);
          });

          if (group.sessions.length > 0) this.examGroups.push(group);
        });

        this.renderExamGroups();
        this.populateAdminFilters();
      },

      renderExamGroups: async function () {
        document.getElementById("exam-list-loader").classList.add("d-none");
        document.getElementById("sessions-container").classList.add("d-none");
        document.getElementById("exam-groups-container").classList.remove("d-none");
        document.getElementById("btn-back-to-exams").classList.add("d-none");
        document.getElementById("step1-subtitle").innerText = "Lütfen bir sınav seçiniz.";

        const container = document.getElementById("exam-groups-container");
        container.innerHTML = "";

        if (this.examGroups.length === 0) {
          container.innerHTML = `<div class="col-12"><div class="alert alert-danger m-0">Sınav listesi bulunamadı. Google e-tablo verilerini kontrol ediniz.</div></div>`;
          return;
        }

        this.examGroups.forEach(group => {
          const col = document.createElement("div");
          col.className = "col-md-6";
          const first = group.sessions[0];
          const dateInfo = first?.date ? `${first.date}` : "";
          const sessCount = group.sessions.length;

          col.innerHTML = `
            <div class="exam-card-selection card p-3 h-100" onclick="app.selectExamGroup('${group.groupId}', this)">
              <div class="d-flex justify-content-between align-items-start gap-2">
                <div>
                  <h5 class="fw-bold mb-1">${group.name}</h5>
                  <div class="hint"><i class="fa-regular fa-calendar"></i> ${dateInfo || "Tarih belirtilmedi"} &nbsp; • &nbsp; <i class="fa-regular fa-clock"></i> ${sessCount} seans</div>
                </div>
                <span class="badge text-bg-primary" style="border-radius:999px; padding:8px 10px;">Seç</span>
              </div>
              <div class="mt-2 hint">Sınavı seçtikten sonra uygun seansı ve kontenjan durumunu göreceksiniz.</div>
            </div>
          `;
          container.appendChild(col);
        });
      },

      selectExamGroup: async function (groupId, el) {
        this.selectedGroupId = groupId;
        document.querySelectorAll("#exam-groups-container .exam-card-selection").forEach(x => x.classList.remove("selected"));
        if (el) el.classList.add("selected");

        document.getElementById("btn-back-to-exams").classList.remove("d-none");
        document.getElementById("step1-subtitle").innerText = "Lütfen bir seans seçiniz. Kontenjan dolu ise seçim yapılamaz.";

        await this.renderSessions(groupId);
      },

      backToExamGroups: function () {
        this.selectedGroupId = null;
        this.selectedSession = null;
        this.renderExamGroups();
      },

      renderSessions: async function (groupId) {
        const group = this.examGroups.find(g => g.groupId === groupId);
        if (!group) return;

        const sessionsEl = document.getElementById("sessions-container");
        const groupsEl = document.getElementById("exam-groups-container");
        sessionsEl.classList.remove("d-none");
        groupsEl.classList.add("d-none");
        sessionsEl.innerHTML = "";

        const snapshot = await get(child(this.dbRef, `bursluluk/registrations`));
        const allRegs = snapshot.val() || {};
        const regsArr = Object.values(allRegs);

        group.sessions.forEach(sess => {
          const count = regsArr.filter(r => r.examId === sess.id).length;
          const remaining = Math.max(0, sess.quota - count);
          const isFull = remaining <= 0 || sess.quota <= 0;

          const col = document.createElement("div");
          col.className = "col-md-6";
          col.innerHTML = `
            <div class="exam-card-selection card p-3 h-100 ${isFull ? "disabled-option" : ""}" onclick="${isFull ? "" : `app.selectSession('${sess.id}', this)`}">
              <div class="d-flex justify-content-between align-items-start gap-2">
                <div>
                  <div class="fw-bold">${sess.name}</div>
                  <div class="hint mt-1">
                    <i class="fa-regular fa-calendar"></i> ${sess.date || "-"}<br>
                    <i class="fa-regular fa-clock"></i> ${sess.time || "-"}
                  </div>
                </div>
                <span class="badge ${isFull ? "text-bg-danger" : "text-bg-success"}" style="border-radius:999px; padding:8px 10px;">
                  ${isFull ? "DOLDU" : `Kalan: ${remaining}`}
                </span>
              </div>
              <div class="hint mt-2">Kontenjan: ${sess.quota} • Mevcut kayıt: ${count}</div>
            </div>
          `;
          sessionsEl.appendChild(col);
        });
      },

      selectSession: function (sessionId, el) {
        this.selectedSession = this.examsData.find(s => s.id === sessionId) || null;
        if (!this.selectedSession) return;

        document.querySelectorAll("#sessions-container .exam-card-selection").forEach(x => x.classList.remove("selected"));
        if (el) el.classList.add("selected");

        const s = this.selectedSession;
        document.getElementById("confirm-text").innerHTML = `
          <div class="mb-1"><strong>${s.name}</strong> sınavına</div>
          <div class="mb-1"><strong>${s.date}</strong> tarihinde, saat <strong>${s.time}</strong> seansına</div>
          <div class="mb-2">kayıt olmak istiyor musunuz?</div>
          <div class="hint">Sınav Yeri: <strong>Fenomen Çocuk Kulübü</strong></div>
        `;

        setTimeout(() => this.goToStep(2), 180);
      },

      resetWizard: function () {
        document.querySelectorAll(".wizard-step").forEach(el => el.classList.remove("active"));
        document.getElementById("step-1").classList.add("active");
        document.getElementById("student-form").reset();
        document.getElementById("reg-tc-check").value = "";
        this.selectedGroupId = null;
        this.selectedSession = null;
        this.renderExamGroups();
      },

      goToStep: function (stepNo) {
        document.querySelectorAll(".wizard-step").forEach(el => el.classList.remove("active"));
        document.getElementById(`step-${stepNo}`).classList.add("active");
        $(".phone-mask").inputmask("(599) 999 99 99", { "placeholder": "_" });
        $("#reg-tc-check").inputmask("99999999999", { "placeholder": "_" });
      },

      checkTCStatus: async function () {
        if (!this.selectedSession) {
          Swal.fire({ icon: "warning", title: "Seans Seçilmedi", text: "Lütfen önce sınav ve seans seçimi yapınız." });
          this.goToStep(1);
          return;
        }

        const tc = (document.getElementById("reg-tc-check").value || "").replace(/\\D/g, "");
        if (tc.length !== 11) {
          Swal.fire({ icon: "warning", title: "Hatalı TC", text: "Lütfen 11 haneli TC kimlik numarasını doğru giriniz." });
          return;
        }

        const examId = this.selectedSession.id;

        const tcSnap = await get(child(this.dbRef, `bursluluk/tcIndex/${examId}/${tc}`));
        const regKey = tcSnap.val();

        if (regKey) {
          Swal.fire({
            icon: "info",
            title: "Kayıt Mevcut",
            text: "Bu sınava daha önce başvurunuz alınmıştır.",
            confirmButtonText: "Tamam"
          }).then(() => this.goHome());
          return;
        }

        const snapshot = await get(child(this.dbRef, `bursluluk/registrations`));
        const allRegs = snapshot.val() || {};
        const existing = Object.values(allRegs).find(r => r.tc === tc && r.examId === examId);

        if (existing) {
          Swal.fire({
            icon: "info",
            title: "Kayıt Mevcut",
            text: "Bu sınava daha önce başvurunuz alınmıştır.",
            confirmButtonText: "Tamam"
          }).then(() => this.goHome());
        } else {
          this.goToStep(4);
        }
      },

      validateStudentForm: function () {
        const name = (document.getElementById("form-student-name").value || "").trim();
        const school = (document.getElementById("form-school").value || "").trim();
        const parent = (document.getElementById("form-parent-name").value || "").trim();
        const phone1 = (document.getElementById("form-phone1").value || "").trim();
        const phone2 = (document.getElementById("form-phone2").value || "").trim();

        const problems = [];
        if (name.split(" ").filter(Boolean).length < 2) problems.push("Öğrenci adı en az 2 kelime olmalıdır (Ad Soyad).");
        if (!school) problems.push("Okul alanı boş bırakılamaz.");
        if (parent.split(" ").filter(Boolean).length < 2) problems.push("Veli adı en az 2 kelime olmalıdır (Ad Soyad).");
        if (!phone1 || phone1.includes("_")) problems.push("Telefon 1 alanını eksiksiz doldurunuz.");
        if (phone2 && phone2.includes("_")) problems.push("Telefon 2 alanı eksik girilmiş görünüyor. Doldurmayacaksanız boş bırakınız.");

        return { ok: problems.length === 0, problems, data: { name, school, parent, phone1, phone2 } };
      },

      allocateAndReserve: async function ({ exam, tc, newKey }) {
        const metaRef = ref(this.db, `bursluluk/examsMeta/${exam.id}`);

        const result = await runTransaction(metaRef, (meta) => {
          meta = meta || {};
          meta.quota = exam.quota;
          meta.startNum = exam.startNum;

          meta.usedNos = meta.usedNos || {};
          meta.tcs = meta.tcs || {};
          meta.count = meta.count || 0;

          if (meta.tcs[tc]) return;
          if (meta.count >= meta.quota) return;

          const used = meta.usedNos || {};
          let candidate = meta.startNum;
          for (let i = 0; i < 200000; i++) {
            if (!used[String(candidate)]) break;
            candidate++;
          }

          meta.usedNos[String(candidate)] = true;
          meta.tcs[tc] = newKey;
          meta.count = (meta.count || 0) + 1;
          meta.lastAssignedNo = candidate;
          meta.lastAssignedAt = nowISO();
          return meta;
        }, { applyLocally: false });

        return result;
      },

      submitRegistration: async function () {
        if (!this.selectedSession) {
          Swal.fire({ icon: "warning", title: "Seans Seçilmedi", text: "Lütfen önce sınav ve seans seçimi yapınız." });
          this.goToStep(1);
          return;
        }

        const tc = (document.getElementById("reg-tc-check").value || "").replace(/\\D/g, "");
        if (tc.length !== 11) {
          Swal.fire({ icon: "warning", title: "Hatalı TC", text: "Lütfen 11 haneli TC kimlik numarasını doğru giriniz." });
          this.goToStep(3);
          return;
        }

        const v = this.validateStudentForm();
        if (!v.ok) {
          Swal.fire({
            icon: "warning",
            title: "Eksik / Hatalı Bilgi",
            html: `<div class="text-start">
                    <div class="mb-2">Lütfen aşağıdaki maddeleri kontrol ediniz:</div>
                    <ul>${v.problems.map(p => `<li>${p}</li>`).join("")}</ul>
                  </div>`,
            confirmButtonText: "Anladım"
          });
          return;
        }

        const tcIndexSnap = await get(child(this.dbRef, `bursluluk/tcIndex/${this.selectedSession.id}/${tc}`));
        if (tcIndexSnap.val()) {
          Swal.fire({ icon: "info", title: "Kayıt Mevcut", text: "Bu sınava daha önce başvurunuz alınmıştır." }).then(() => this.goHome());
          return;
        }

        Swal.fire({
          title: "Kaydınız Oluşturuluyor",
          text: "Lütfen bekleyiniz...",
          allowOutsideClick: false,
          didOpen: () => Swal.showLoading()
        });

        const exam = this.selectedSession;
        const newKey = push(child(this.dbRef, "bursluluk/registrations")).key;

        try {
          const tx = await this.allocateAndReserve({ exam, tc, newKey });

          if (!tx.committed) {
            await Swal.fire({ icon: "warning", title: "Kayıt Alınamadı", text: "Bu seans için kontenjan dolmuş olabilir veya bu TC ile daha önce kayıt yapılmıştır." });
            Swal.close();
            await this.renderSessions(this.selectedGroupId);
            this.goToStep(1);
            return;
          }

          const meta = tx.snapshot.val() || {};
          const assignedNo = meta.lastAssignedNo;

          const newReg = {
            tc: tc,
            studentName: v.data.name,
            school: v.data.school,
            parentName: v.data.parent,
            phone1: v.data.phone1,
            phone2: v.data.phone2,
            examId: exam.id,
            examName: exam.name,
            examDate: exam.date,
            examTime: exam.time,
            studentNo: assignedNo,
            regDate: nowISO()
          };

          const updates = {};
          updates[`bursluluk/registrations/${newKey}`] = newReg;
          updates[`bursluluk/tcIndex/${exam.id}/${tc}`] = newKey;

          await update(ref(this.db), updates);

          Swal.close();
          this.showSuccessCard(newReg);

        } catch (err) {
          console.error("Registration error:", err);
          Swal.close();
          Swal.fire({ icon: "error", title: "Hata", text: "Kayıt sırasında bir hata oluştu. Lütfen tekrar deneyiniz." });
        }
      },

      showSuccessCard: function (data) {
        this.goToStep(5);
        document.getElementById("final-card-preview").innerHTML = this.createCardHTML(data, true);
      },

      createCardHTML: function (data, isPreview = false) {
        return `
          <div class="student-card">
            ${isPreview ? `<div class="watermark">ÖRNEKTİR • BASKI ALINAMAZ</div>` : ``}
            <div class="card-top">
              <div>
                <p class="card-title">Fenomen Çocuk Kulübü</p>
                <p class="card-sub">Öğrenci Giriş Kartı</p>
              </div>
              <div class="badge-chip">
                <div class="text-danger fw-bold" style="font-size:12px;">#${data.studentNo}</div>
                <div class="hint" style="font-size:10px; margin-top:-2px;">Öğrenci No</div>
              </div>
            </div>

            <div class="card-info">
              <div class="card-label">Adı Soyadı:</div><div class="card-value">${data.studentName}</div>
              <div class="card-label">Okulu:</div><div class="card-value">${data.school}</div>
              <div class="card-label">TC No:</div><div class="card-value">${maskTC(data.tc)}</div>
              <div class="card-label">Sınav:</div><div class="card-value">${data.examName}</div>
              <div class="card-label">Tarih/Saat:</div><div class="card-value">${data.examDate} • ${data.examTime}</div>
              <div class="card-label">Sınav Yeri:</div><div class="card-value"><strong>Fenomen Çocuk Kulübü</strong></div>
            </div>
          </div>
        `;
      },

      searchStudent: async function () {
        const queryRaw = (document.getElementById("search-query").value || "").trim();
        if (!queryRaw) return;

        const query = queryRaw.replace(/\\D/g, "");

        const snapshot = await get(child(this.dbRef, `bursluluk/registrations`));
        const allRegs = snapshot.val() || {};

        const results = Object.entries(allRegs).filter(([key, r]) => {
          if (!r) return false;
          if (query.length === 11) return r.tc === query;
          if (isDigits(query) && query.length > 0) return String(r.studentNo) === String(query);
          return false;
        });

        const resContainer = document.getElementById("search-results");
        resContainer.innerHTML = "";

        if (results.length === 0) {
          resContainer.innerHTML = `<div class="alert alert-danger" style="border-radius:16px;">Bu numara ile herhangi bir başvuru bulunamadı.</div>`;
          return;
        }

        results.sort((a,b) => {
          const ra = a[1], rb = b[1];
          const da = `${ra.examDate} ${ra.examTime}`.localeCompare(`${rb.examDate} ${rb.examTime}`, "tr");
          if (da !== 0) return da;
          return (Number(ra.studentNo) || 0) - (Number(rb.studentNo) || 0);
        });

        results.forEach(([key, r]) => {
          const item = document.createElement("div");
          item.className = "card mb-3 p-3 shadow-sm";
          item.style.borderRadius = "16px";
          item.innerHTML = `
            <div class="row align-items-center g-2">
              <div class="col-md-8">
                <div class="fw-bold">${r.studentName} <span class="text-muted fw-normal">(#${r.studentNo})</span></div>
                <div class="hint mt-1">${r.examName} • ${r.examDate} • ${r.examTime}</div>
              </div>
              <div class="col-md-4 text-end">
                <button class="btn btn-info btn-sm text-white" onclick="app.printSingleCard('${key}')"><i class="fas fa-print"></i> Kartı Bas</button>
                <button class="btn btn-danger btn-sm" onclick="app.initCancel('${key}', '${String(r.studentName).replace(/'/g,"&#39;")}')"><i class="fa-solid fa-ban"></i> Sınava Girmekten Vazgeçtim</button>
              </div>
            </div>
          `;
          resContainer.appendChild(item);
        });
      },

      initCancel: function (key, name) {
        this.currentUserToDelete = { key, name };
        document.getElementById("cancel-name-target").innerText = name;
        document.getElementById("cancel-confirm-input").value = "";
        new bootstrap.Modal(document.getElementById("cancelModal")).show();
      },

      confirmCancellation: async function () {
        if (!this.currentUserToDelete) return;

        const input = document.getElementById("cancel-confirm-input").value;
        const target = `${this.currentUserToDelete.name} sınav iptal`;

        if (normalizeTR(input) !== normalizeTR(target)) {
          Swal.fire({ icon: "error", title: "Hata", text: "Doğrulama metnini yanlış girdiniz. Lütfen tam adınızı ve 'sınav iptal' ifadesini doğru yazınız." });
          return;
        }

        const confirm = await Swal.fire({
          icon: "warning",
          title: "Onaylıyor musunuz?",
          text: "Bu işlem geri dönüşü olmayan şekilde kaydı silecektir.",
          showCancelButton: true,
          confirmButtonText: "Evet, Sil",
          cancelButtonText: "Vazgeç"
        });

        if (!confirm.isConfirmed) return;

        const key = this.currentUserToDelete.key;

        try {
          const snap = await get(child(this.dbRef, `bursluluk/registrations/${key}`));
          const reg = snap.val();
          if (!reg) {
            Swal.fire({ icon: "info", title: "Kayıt Bulunamadı", text: "Kayıt zaten silinmiş olabilir." });
            bootstrap.Modal.getInstance(document.getElementById("cancelModal")).hide();
            this.searchStudent();
            return;
          }

          const metaRef = ref(this.db, `bursluluk/examsMeta/${reg.examId}`);
          await runTransaction(metaRef, (meta) => {
            meta = meta || {};
            meta.usedNos = meta.usedNos || {};
            meta.tcs = meta.tcs || {};
            if (meta.usedNos[String(reg.studentNo)]) delete meta.usedNos[String(reg.studentNo)];
            if (meta.tcs[String(reg.tc)]) delete meta.tcs[String(reg.tc)];
            meta.count = Math.max(0, (meta.count || 1) - 1);
            meta.lastReleasedAt = nowISO();
            return meta;
          }, { applyLocally: false });

          const updates = {};
          updates[`bursluluk/registrations/${key}`] = null;
          updates[`bursluluk/tcIndex/${reg.examId}/${reg.tc}`] = null;
          await update(ref(this.db), updates);

          Swal.fire({ icon: "success", title: "Silindi", text: "Kayıt başarıyla silindi ve kontenjan açıldı." });
          bootstrap.Modal.getInstance(document.getElementById("cancelModal")).hide();
          this.searchStudent();
        } catch (err) {
          console.error("cancel error:", err);
          Swal.fire({ icon: "error", title: "Hata", text: "Silme işlemi sırasında hata oluştu. Lütfen tekrar deneyiniz." });
        }
      },

      checkAdmin: function () {
        const pass = document.getElementById("admin-pass").value;
        if (pass === "13579") {
          document.getElementById("admin-login").classList.add("d-none");
          document.getElementById("admin-panel").classList.remove("d-none");
          this.adminLoadData();
          this.populateAdminFilters();
        } else {
          Swal.fire({ icon: "error", title: "Hatalı Şifre", text: "Şifre doğrulanamadı." });
        }
      },

      adminRefresh: function () {
        this.adminLoadData();
      },

      populateAdminFilters: function () {
        const examSel = document.getElementById("admin-filter-exam");
        const sessionSel = document.getElementById("admin-filter-session");

        const uniqueSessions = this.examsData.map(e => ({ id: e.id, label: `${e.name} • ${e.date} • ${e.time}`, time: e.time }));
        const uniqueTimes = [...new Set(this.examsData.map(e => e.time))];

        examSel.innerHTML = `<option value="">Tüm Sınavlar</option>`;
        uniqueSessions.forEach(s => {
          examSel.innerHTML += `<option value="${s.id}">${s.label}</option>`;
        });

        sessionSel.innerHTML = `<option value="">Tüm Seanslar</option>`;
        uniqueTimes.forEach(t => sessionSel.innerHTML += `<option value="${t}">${t}</option>`);
      },

      adminLoadData: async function () {
        const snapshot = await get(child(this.dbRef, `bursluluk/registrations`));
        const allRegs = snapshot.val() || {};
        let data = Object.entries(allRegs).map(([key, val]) => ({ ...val, key }));
        this.adminDataCache = data;

        const filterExam = document.getElementById("admin-filter-exam").value;
        const filterSession = document.getElementById("admin-filter-session").value;
        const search = normalizeTR(document.getElementById("admin-search").value);

        if (filterExam) data = data.filter(d => d.examId === filterExam);
        if (filterSession) data = data.filter(d => d.examTime === filterSession);
        if (search) {
          data = data.filter(d =>
            normalizeTR(d.studentName).includes(search) ||
            normalizeTR(d.tc).includes(search) ||
            normalizeTR(String(d.studentNo)).includes(search)
          );
        }

        data.sort((a,b) => {
          const ea = `${a.examName} ${a.examDate} ${a.examTime}`.localeCompare(`${b.examName} ${b.examDate} ${b.examTime}`, "tr");
          if (ea !== 0) return ea;
          return (Number(a.studentNo) || 0) - (Number(b.studentNo) || 0);
        });

        this.renderAdminTable(data);
      },

      renderAdminTable: function (data) {
        const tbody = document.getElementById("admin-table-body");
        tbody.innerHTML = "";

        if (data.length === 0) {
          tbody.innerHTML = `<tr><td colspan="9" class="text-center text-muted py-4">Kayıt bulunamadı.</td></tr>`;
          return;
        }

        data.forEach(row => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td><input type="checkbox" class="admin-select-row" value="${row.key}"></td>
            <td class="fw-bold">#${row.studentNo}</td>
            <td>${row.tc}</td>
            <td>${row.studentName}</td>
            <td>${row.school || ""}</td>
            <td>${row.parentName || ""}</td>
            <td>${row.phone1 || ""}</td>
            <td>
              <div class="fw-semibold">${row.examName}</div>
              <div class="hint">${row.examDate} • ${row.examTime}</div>
            </td>
            <td>
              <div class="d-flex gap-1">
                <button class="btn btn-sm btn-info text-white" title="Kart Bas" onclick="app.printSingleCard('${row.key}', true)"><i class="fas fa-print"></i></button>
                <button class="btn btn-sm btn-warning" title="Düzenle" onclick="app.editStudent('${row.key}')"><i class="fas fa-edit"></i></button>
              </div>
            </td>
          `;
          tbody.appendChild(tr);
        });
      },

      toggleSelectAll: function () {
        const master = document.getElementById("select-all").checked;
        document.querySelectorAll(".admin-select-row").forEach(cb => cb.checked = master);
      },

      printSingleCard: async function (key, fromAdmin = false) {
        let data;
        if (fromAdmin) data = this.adminDataCache.find(d => d.key === key);
        else {
          const snapshot = await get(child(this.dbRef, `bursluluk/registrations/${key}`));
          data = snapshot.val();
        }
        if (!data) return;

        const printArea = document.getElementById("print-area");
        printArea.innerHTML = `<div class="print-grid">${this.createCardHTML(data, false)}</div>`;
        window.print();
      },

      adminPrintBatchCards: function () {
        const selected = Array.from(document.querySelectorAll(".admin-select-row:checked")).map(cb => cb.value);
        if (selected.length === 0) {
          Swal.fire({ icon: "warning", title: "Uyarı", text: "Lütfen listeden en az bir öğrenci seçiniz." });
          return;
        }

        const items = selected.map(key => this.adminDataCache.find(d => d.key === key)).filter(Boolean);
        items.sort((a,b) => (Number(a.studentNo)||0) - (Number(b.studentNo)||0));

        const printArea = document.getElementById("print-area");
        printArea.innerHTML = `<div class="print-grid">${items.map(d => this.createCardHTML(d, false)).join("")}</div>`;
        window.print();
      },

      adminPrintList: async function () {
        const selected = Array.from(document.querySelectorAll(".admin-select-row:checked")).map(cb => cb.value);
        const filterExam = document.getElementById("admin-filter-exam").value;
        const filterSession = document.getElementById("admin-filter-session").value;
        const search = normalizeTR(document.getElementById("admin-search").value);

        let targetData = this.adminDataCache.slice();
        if (filterExam) targetData = targetData.filter(d => d.examId === filterExam);
        if (filterSession) targetData = targetData.filter(d => d.examTime === filterSession);
        if (search) {
          targetData = targetData.filter(d =>
            normalizeTR(d.studentName).includes(search) ||
            normalizeTR(d.tc).includes(search) ||
            normalizeTR(String(d.studentNo)).includes(search)
          );
        }
        if (selected.length > 0) targetData = targetData.filter(d => selected.includes(d.key));

        if (targetData.length === 0) {
          Swal.fire({ icon: "info", title: "Liste Boş", text: "Yoklama listesi için kayıt bulunamadı." });
          return;
        }

        const { value: cols } = await Swal.fire({
          title: "Yoklama Listesi Alanları",
          html: `
            <div class="text-start">
              <div class="form-check"><input class="form-check-input" type="checkbox" id="c_no" checked><label class="form-check-label" for="c_no">Öğr No</label></div>
              <div class="form-check"><input class="form-check-input" type="checkbox" id="c_name" checked><label class="form-check-label" for="c_name">Ad Soyad</label></div>
              <div class="form-check"><input class="form-check-input" type="checkbox" id="c_tc" checked><label class="form-check-label" for="c_tc">TC</label></div>
              <div class="form-check"><input class="form-check-input" type="checkbox" id="c_school" checked><label class="form-check-label" for="c_school">Okul</label></div>
              <div class="form-check"><input class="form-check-input" type="checkbox" id="c_exam" checked><label class="form-check-label" for="c_exam">Sınav/Seans</label></div>
              <div class="form-check"><input class="form-check-input" type="checkbox" id="c_phone"><label class="form-check-label" for="c_phone">Telefon</label></div>
              <div class="form-check"><input class="form-check-input" type="checkbox" id="c_sign" checked><label class="form-check-label" for="c_sign">İmza</label></div>
            </div>
          `,
          confirmButtonText: "Oluştur",
          showCancelButton: true,
          cancelButtonText: "Vazgeç",
          preConfirm: () => ({
            no: document.getElementById("c_no").checked,
            name: document.getElementById("c_name").checked,
            tc: document.getElementById("c_tc").checked,
            school: document.getElementById("c_school").checked,
            exam: document.getElementById("c_exam").checked,
            phone: document.getElementById("c_phone").checked,
            sign: document.getElementById("c_sign").checked,
          })
        });

        if (!cols) return;

        const headers = [];
        if (cols.no) headers.push("Öğr No");
        if (cols.name) headers.push("Ad Soyad");
        if (cols.tc) headers.push("TC");
        if (cols.school) headers.push("Okul");
        if (cols.phone) headers.push("Telefon");
        if (cols.exam) headers.push("Sınav/Seans");
        if (cols.sign) headers.push("İmza");

        targetData.sort((a,b) => {
          const ea = `${a.examName} ${a.examDate} ${a.examTime}`.localeCompare(`${b.examName} ${b.examDate} ${b.examTime}`, "tr");
          if (ea !== 0) return ea;
          return (Number(a.studentNo)||0) - (Number(b.studentNo)||0);
        });

        const titleInfo = (() => {
          if (filterExam) {
            const ex = this.examsData.find(e => e.id === filterExam);
            if (ex) return `${ex.name} • ${ex.date} • ${ex.time}`;
          }
          return "Tüm Kayıtlar";
        })();

        const printArea = document.getElementById("print-area");
        printArea.innerHTML = `
          <div style="padding:14mm;">
            <div style="display:flex;justify-content:space-between;align-items:flex-end;margin-bottom:8mm;">
              <div>
                <div style="font-weight:800;font-size:18px;">Yoklama Listesi</div>
                <div style="color:#555;font-size:12px;">${titleInfo}</div>
              </div>
              <div style="color:#555;font-size:11px;">Oluşturma: ${new Date().toLocaleString("tr-TR")}</div>
            </div>
            <table style="width:100%; border-collapse:collapse; border:1px solid #000; font-size:11px;">
              <thead>
                <tr style="background:#e5e7eb;">
                  ${headers.map(h => `<th style="border:1px solid #000; padding:6px; text-align:left;">${h}</th>`).join("")}
                </tr>
              </thead>
              <tbody>
                ${targetData.map(d => {
                  const cells = [];
                  if (cols.no) cells.push(`#${d.studentNo}`);
                  if (cols.name) cells.push(d.studentName || "");
                  if (cols.tc) cells.push(d.tc || "");
                  if (cols.school) cells.push(d.school || "");
                  if (cols.phone) cells.push(d.phone1 || "");
                  if (cols.exam) cells.push(`${d.examName} • ${d.examDate} • ${d.examTime}`);
                  if (cols.sign) cells.push("");
                  return `<tr>${cells.map(c => `<td style="border:1px solid #000; padding:6px;">${c}</td>`).join("")}</tr>`;
                }).join("")}
              </tbody>
            </table>
          </div>
        `;

        window.print();
      },

      openQuickReg: async function () {
        const modal = new bootstrap.Modal(document.getElementById("quickRegModal"));

        const sessionOptions = this.examsData.map(e => `<option value="${e.id}">${e.name} • ${e.date} • ${e.time} (Knt: ${e.quota})</option>`).join("");

        document.getElementById("quick-reg-body").innerHTML = `
          <div class="alert alert-info" style="border-radius:16px;">
            Admin hızlı kayıt: Seansı seçin, TC ile kontrol edin ve bilgileri girerek kaydedin.
          </div>

          <div class="row g-3">
            <div class="col-md-12">
              <label class="form-label">Sınav / Seans</label>
              <select id="qr-exam" class="form-select form-select-lg">${sessionOptions}</select>
              <div class="form-text">Kontenjan doluysa kayıt alınmaz.</div>
            </div>

            <div class="col-md-6">
              <label class="form-label">TC Kimlik No</label>
              <input id="qr-tc" class="form-control form-control-lg text-center" placeholder="___________" inputmode="numeric">
            </div>
            <div class="col-md-6 d-flex align-items-end">
              <button class="btn btn-outline-primary btn-lg w-100" onclick="app.qrCheckTC()"><i class="fa-solid fa-magnifying-glass"></i> TC Kontrol</button>
            </div>

            <div class="col-12"><div class="soft-divider"></div></div>

            <div class="col-md-6">
              <label class="form-label">Öğrenci Ad Soyad</label>
              <input id="qr-student" class="form-control" placeholder="Örn: Ali Yılmaz">
            </div>
            <div class="col-md-6">
              <label class="form-label">Okulu</label>
              <input id="qr-school" class="form-control">
            </div>
            <div class="col-md-6">
              <label class="form-label">Veli Ad Soyad</label>
              <input id="qr-parent" class="form-control" placeholder="Örn: Ayşe Yılmaz">
            </div>
            <div class="col-md-6">
              <label class="form-label">Telefon 1</label>
              <input id="qr-phone1" class="form-control phone-mask" placeholder="(5__) ___ __ __">
            </div>
            <div class="col-md-6">
              <label class="form-label">Telefon 2 (opsiyonel)</label>
              <input id="qr-phone2" class="form-control phone-mask" placeholder="(5__) ___ __ __">
            </div>

            <div class="col-12 d-flex justify-content-end gap-2">
              <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Kapat</button>
              <button class="btn btn-success" onclick="app.qrSubmit()"><i class="fa-solid fa-floppy-disk"></i> Hızlı Kaydet</button>
            </div>
          </div>
        `;

        $("#qr-tc").inputmask("99999999999", { "placeholder": "_" });
        $(".phone-mask").inputmask("(599) 999 99 99", { "placeholder": "_" });

        modal.show();
      },

      qrCheckTC: async function () {
        const examId = document.getElementById("qr-exam").value;
        const tc = (document.getElementById("qr-tc").value || "").replace(/\\D/g, "");
        if (tc.length !== 11) {
          Swal.fire({ icon: "warning", title: "Hatalı TC", text: "11 haneli TC giriniz." });
          return;
        }
        const snap = await get(child(this.dbRef, `bursluluk/tcIndex/${examId}/${tc}`));
        if (snap.val()) {
          Swal.fire({ icon: "info", title: "Kayıt Mevcut", text: "Bu TC ile bu seansa daha önce kayıt yapılmıştır." });
        } else {
          Swal.fire({ icon: "success", title: "Uygun", text: "Bu TC ile bu seansa kayıt bulunamadı. Devam edebilirsiniz." });
        }
      },

      qrSubmit: async function () {
        const examId = document.getElementById("qr-exam").value;
        const exam = this.examsData.find(e => e.id === examId);
        if (!exam) return;

        const tc = (document.getElementById("qr-tc").value || "").replace(/\\D/g, "");
        const studentName = (document.getElementById("qr-student").value || "").trim();
        const school = (document.getElementById("qr-school").value || "").trim();
        const parentName = (document.getElementById("qr-parent").value || "").trim();
        const phone1 = (document.getElementById("qr-phone1").value || "").trim();
        const phone2 = (document.getElementById("qr-phone2").value || "").trim();

        const problems = [];
        if (tc.length !== 11) problems.push("TC 11 hane olmalıdır.");
        if (studentName.split(" ").filter(Boolean).length < 2) problems.push("Öğrenci adı en az 2 kelime olmalıdır.");
        if (!school) problems.push("Okul boş bırakılamaz.");
        if (parentName.split(" ").filter(Boolean).length < 2) problems.push("Veli adı en az 2 kelime olmalıdır.");
        if (!phone1 || phone1.includes("_")) problems.push("Telefon 1 eksik.");
        if (phone2 && phone2.includes("_")) problems.push("Telefon 2 eksik girilmiş.");

        if (problems.length) {
          Swal.fire({ icon: "warning", title: "Eksik Bilgi", html: `<ul class="text-start">${problems.map(p=>`<li>${p}</li>`).join("")}</ul>` });
          return;
        }

        Swal.fire({
          title: "Kaydediliyor",
          text: "Lütfen bekleyiniz...",
          allowOutsideClick: false,
          didOpen: () => Swal.showLoading()
        });

        const newKey = push(child(this.dbRef, "bursluluk/registrations")).key;

        try {
          const tx = await this.allocateAndReserve({ exam, tc, newKey });

          if (!tx.committed) {
            Swal.close();
            Swal.fire({ icon: "warning", title: "Kayıt Alınamadı", text: "Kontenjan dolu olabilir veya bu TC ile kayıt vardır." });
            return;
          }

          const meta = tx.snapshot.val() || {};
          const assignedNo = meta.lastAssignedNo;

          const newReg = {
            tc,
            studentName,
            school,
            parentName,
            phone1,
            phone2,
            examId: exam.id,
            examName: exam.name,
            examDate: exam.date,
            examTime: exam.time,
            studentNo: assignedNo,
            regDate: nowISO()
          };

          const updates = {};
          updates[`bursluluk/registrations/${newKey}`] = newReg;
          updates[`bursluluk/tcIndex/${exam.id}/${tc}`] = newKey;
          await update(ref(this.db), updates);

          Swal.close();
          Swal.fire({ icon: "success", title: "Başarılı", html: `<div>Kayıt oluşturuldu. Öğrenci No: <strong>#${assignedNo}</strong></div>` });
          bootstrap.Modal.getInstance(document.getElementById("quickRegModal")).hide();
          this.adminLoadData();
        } catch (err) {
          console.error("qr submit:", err);
          Swal.close();
          Swal.fire({ icon: "error", title: "Hata", text: "Kayıt sırasında hata oluştu." });
        }
      }
    };

    document.addEventListener("DOMContentLoaded", () => app.init());
  </script>
</body>
</html>
