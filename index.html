<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fenomen Eğitim Kurumları - Bursluluk & LGS Provası</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f4f6f9; }
        .hero-section { text-align: center; padding: 50px 20px; }
        .main-btn {
            width: 100%; height: 120px; font-size: 1.5rem; border-radius: 15px;
            transition: transform 0.2s, box-shadow 0.2s; border: none; color: white;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .main-btn:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        .btn-new { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .btn-info { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
        .btn-admin { background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%); }
        
        /* Wizard Steps */
        .wizard-step { display: none; animation: fadeIn 0.5s; }
        .wizard-step.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Exam Card Preview */
        .exam-card {
            width: 85.6mm; height: 53.98mm; /* Standard ID Card Size */
            border: 1px solid #ccc; background: white; padding: 10px;
            position: relative; box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            margin: 0 auto; overflow: hidden; page-break-inside: avoid;
            background-image: url('https://www.transparenttextures.com/patterns/cubes.png');
        }
        .exam-card-header { background: #d9534f; color: white; padding: 5px; text-align: center; font-size: 12px; font-weight: bold; border-radius: 4px; }
        .exam-card-body { font-size: 11px; margin-top: 5px; }
        .exam-card-row { display: flex; justify-content: space-between; margin-bottom: 2px; border-bottom: 1px dashed #eee; }
        .exam-card-label { font-weight: bold; color: #555; }

        /* Admin Print Styles */
        @media print {
            body * { visibility: hidden; }
            #printArea, #printArea * { visibility: visible; }
            #printArea { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none !important; }
            .page-break { page-break-after: always; }
            .print-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 10px; }
        }
    </style>
</head>
<body>

<div class="container hero-section" id="mainMenu">
    <h1 class="mb-4 text-primary"><i class="fas fa-graduation-cap"></i> Fenomen Eğitim Kurumları</h1>
    <h4 class="mb-5 text-secondary">Bursluluk ve LGS Provası Başvuru Sistemi</h4>
    
    <div class="row g-4 justify-content-center">
        <div class="col-md-4">
            <button class="main-btn btn-new" onclick="startNewRegistration()">
                <i class="fas fa-user-plus fa-2x mb-2"></i> Yeni Kayıt
            </button>
        </div>
        <div class="col-md-4">
            <button class="main-btn btn-info" onclick="openStudentInfo()">
                <i class="fas fa-search fa-2x mb-2"></i> Kayıtlı Bilgisi
            </button>
        </div>
        <div class="col-md-4">
            <button class="main-btn btn-admin" onclick="openAdminPanel()">
                <i class="fas fa-user-shield fa-2x mb-2"></i> Yönetici Bölümü
            </button>
        </div>
    </div>
</div>

<div class="container mt-5" id="wizardContainer" style="display:none;">
    <div class="card shadow">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Sınav Kayıt İşlemleri</h5>
            <button class="btn btn-sm btn-light" onclick="returnToMain()">Ana Menü</button>
        </div>
        <div class="card-body">
            
            <div class="wizard-step active" id="step1">
                <h4 class="text-center mb-4">Lütfen Katılmak İstediğiniz Sınavı Seçiniz</h4>
                <div class="alert alert-info text-center" id="loadingAlert" style="display:none;">Sınav bilgileri yükleniyor...</div>
                <div class="d-flex justify-content-center mb-3">
                    <select class="form-select form-select-lg w-75" id="examSelect" onchange="loadExamDetails()">
                        <option value="">Sınav Seçiniz...</option>
                    </select>
                </div>
                <div id="examDetailsArea" class="mt-4" style="display:none;">
                    <table class="table table-hover">
                        <thead><tr><th>Tarih</th><th>Saat</th><th>Kalan Kontenjan</th><th>İşlem</th></tr></thead>
                        <tbody id="sessionTableBody"></tbody>
                    </table>
                </div>
            </div>

            <div class="wizard-step" id="step2">
                <div class="text-center">
                    <h3 class="text-primary mb-3">Seçim Onayı</h3>
                    <p class="lead" id="confirmText">...</p>
                    <hr>
                    <button class="btn btn-secondary btn-lg me-2" onclick="changeStep(1)">Hayır, Geri Dön</button>
                    <button class="btn btn-success btn-lg" onclick="changeStep(3)">Evet, Devam Et</button>
                </div>
            </div>

            <div class="wizard-step" id="step3">
                <div class="row justify-content-center">
                    <div class="col-md-6 text-center">
                        <label class="form-label">Öğrenci T.C. Kimlik Numarası</label>
                        <input type="text" class="form-control form-control-lg text-center" id="tcCheckInput" maxlength="11" placeholder="11 haneli TC giriniz">
                        <button class="btn btn-primary mt-3 w-100" onclick="checkTCAndProceed()">Sorgula ve Devam Et</button>
                    </div>
                </div>
            </div>

            <div class="wizard-step" id="step4">
                <h4 class="mb-3 border-bottom pb-2">Öğrenci ve Veli Bilgileri</h4>
                <form id="regForm" onsubmit="event.preventDefault(); completeRegistration();">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Öğrenci Adı Soyadı</label>
                            <input type="text" class="form-control" id="stdName" required minlength="5" placeholder="En az 2 kelime">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Okulu</label>
                            <input type="text" class="form-control" id="stdSchool" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Veli Adı Soyadı</label>
                            <input type="text" class="form-control" id="parentName" required minlength="5">
                        </div>
                        <div class="col-md-6"></div> 

                        <div class="col-md-6">
                            <label class="form-label">Veli Telefon 1</label>
                            <input type="text" class="form-control phone-mask" id="phone1" placeholder="(5XX) XXX XX XX" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Veli Telefon 2</label>
                            <input type="text" class="form-control phone-mask" id="phone2" placeholder="(5XX) XXX XX XX">
                        </div>
                        <div class="col-12 alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i> Uyarı: Bilgilendirmeler telefon üzerinden yapılacaktır. Yanlış girmeyiniz.
                        </div>
                    </div>
                    <div class="text-end mt-4">
                        <button type="submit" class="btn btn-success btn-lg">Kaydı Tamamla</button>
                    </div>
                </form>
            </div>

            <div class="wizard-step" id="step5">
                <div class="text-center">
                    <i class="fas fa-check-circle text-success fa-5x mb-3"></i>
                    <h2>Tebrikler! Başvurunuz Alınmıştır.</h2>
                    <p>Giriş kartınız basıma hazırlanmıştır. Sınavdan 2 gün önce kurumumuzdan teslim alabilirsiniz.</p>
                    <div class="d-flex justify-content-center mt-4">
                        <div id="finalCardPreview"></div>
                    </div>
                    <button class="btn btn-primary mt-4" onclick="returnToMain()">Ana Sayfaya Dön</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="infoModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">Öğrenci Kayıt Sorgulama</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="input-group mb-3">
                    <input type="text" class="form-control" id="searchInfoInput" placeholder="T.C. Kimlik veya Öğrenci No giriniz">
                    <button class="btn btn-primary" onclick="searchStudentInfo()">Sorgula</button>
                </div>
                <div id="studentInfoResult"></div>
            </div>
        </div>
    </div>
</div>

<div class="container mt-4" id="adminPanel" style="display:none;">
    <div class="card">
        <div class="card-header bg-dark text-white d-flex justify-content-between">
            <h4>Yönetici Paneli</h4>
            <button class="btn btn-sm btn-outline-light" onclick="returnToMain()">Çıkış</button>
        </div>
        <div class="card-body">
            <div class="row g-2 mb-3 no-print">
                <div class="col-md-3">
                    <select class="form-select" id="adminExamFilter" onchange="renderAdminTable()">
                        <option value="all">Tüm Sınavlar</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <input type="text" class="form-control" id="adminSearch" placeholder="Ara (Ad, TC, No)..." onkeyup="renderAdminTable()">
                </div>
                <div class="col-md-6 text-end">
                    <button class="btn btn-success btn-sm" onclick="adminQuickRegister()"><i class="fas fa-plus"></i> Hızlı Kayıt</button>
                    <button class="btn btn-primary btn-sm" onclick="printList()"><i class="fas fa-print"></i> Liste Çıktısı</button>
                    <button class="btn btn-warning btn-sm" onclick="printBulkCards()"><i class="fas fa-id-card"></i> Toplu Kart Bas</button>
                    <button class="btn btn-danger btn-sm" onclick="bulkDelete()"><i class="fas fa-trash"></i> Seçileni Sil</button>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table table-bordered table-striped" id="adminTable">
                    <thead class="table-dark">
                        <tr>
                            <th><input type="checkbox" id="selectAll" onclick="toggleSelectAll()"></th>
                            <th>Öğrenci No</th>
                            <th>TC Kimlik</th>
                            <th>Ad Soyad</th>
                            <th>Sınav</th>
                            <th>Tarih/Saat</th>
                            <th>İşlemler</th>
                        </tr>
                    </thead>
                    <tbody id="adminTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div id="printArea"></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getDatabase, ref, set, get, child, update, remove, push } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

    // Firebase Config
    const firebaseConfig = {
        apiKey: "AIzaSyAIzu6aNQstwQCdMWODyIwiaVVBm63OeGw",
        authDomain: "odevfeno.firebaseapp.com",
        databaseURL: "https://odevfeno-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "odevfeno",
        storageBucket: "odevfeno.firebasestorage.app",
        messagingSenderId: "662757516934",
        appId: "1:662757516934:web:0042188832f63deb6fd307",
        measurementId: "G-4Q99NQRB38"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Global Variables
    window.examData = []; 
    window.selectedExam = null;
    window.selectedSession = null; 
    window.adminPassword = "13579";
    let dbStudents = []; 

    // --- GOOGLE SHEET FETCH (YENİ VE GÜVENLİ YÖNTEM) ---
    window.fetchExamData = function() {
        const sheetId = "1oJGMO7FOPV4U86peeA63lmMk-wVCKsfWuyw2yefMweg";
        // Google Visualization API kullanarak JSON formatında veri çekiyoruz.
        const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json`;

        const loading = document.getElementById('loadingAlert');
        if(loading) loading.style.display = 'block';

        fetch(url)
        .then(res => res.text())
        .then(text => {
            if(loading) loading.style.display = 'none';
            
            // Google API yanıtını temizle (fazlalık karakterleri sil)
            const jsonString = text.substring(47).slice(0, -2);
            const json = JSON.parse(jsonString);
            
            // Tabloyu İşle
            // Sütunlar: 0:Sınav, 1:Tarih, 2:Seans, 3:Kontenjan, 4:Saatler, 5:İlk numara
            window.examData = [];
            const rows = json.table.rows;

            rows.forEach(row => {
                const c = row.c;
                if(c[0] && c[0].v) { // Sınav adı boş değilse
                    window.examData.push({
                        name: c[0] ? c[0].v : "",
                        dates: c[1] ? c[1].v.toString().split(';') : [],
                        seansCount: c[2] ? parseInt(c[2].v) : 1,
                        quotas: c[3] ? c[3].v.toString().split(';').map(Number) : [0],
                        times: c[4] ? c[4].v.toString().split(';') : [],
                        startNo: c[5] ? parseInt(c[5].v) : 100
                    });
                }
            });

            console.log("Sınav Verileri Yüklendi:", window.examData);
            populateExamDropdown();
            populateAdminExamFilter();
        })
        .catch(err => {
            console.error(err);
            if(loading) loading.style.display = 'none';
            Swal.fire({
                title: "Veri Hatası",
                text: "Sınav bilgileri çekilemedi. Lütfen Google E-Tablonun 'Web'de Yayınla' seçeneğinin aktif olduğundan emin olun.",
                icon: "error"
            });
        });
    }

    // --- NAVIGATION ---
    window.startNewRegistration = () => {
        document.getElementById('mainMenu').style.display = 'none';
        document.getElementById('wizardContainer').style.display = 'block';
        changeStep(1);
        fetchExamData();
    }
    window.returnToMain = () => {
        document.getElementById('wizardContainer').style.display = 'none';
        document.getElementById('adminPanel').style.display = 'none';
        document.getElementById('mainMenu').style.display = 'block';
        document.getElementById('regForm').reset();
    }
    window.changeStep = (stepNo) => {
        document.querySelectorAll('.wizard-step').forEach(el => el.classList.remove('active'));
        document.getElementById(`step${stepNo}`).classList.add('active');
    }

    // --- EXAM LOGIC ---
    function populateExamDropdown() {
        const select = document.getElementById('examSelect');
        select.innerHTML = '<option value="">Sınav Seçiniz...</option>';
        window.examData.forEach((exam, index) => {
            select.innerHTML += `<option value="${index}">${exam.name}</option>`;
        });
    }

    window.loadExamDetails = async () => {
        const index = document.getElementById('examSelect').value;
        const area = document.getElementById('examDetailsArea');
        const tbody = document.getElementById('sessionTableBody');
        tbody.innerHTML = '<tr><td colspan="4">Kontenjanlar yükleniyor...</td></tr>';
        area.style.display = 'block';

        if(index === "") { area.style.display = 'none'; return; }
        
        window.selectedExam = window.examData[index];
        const snapshot = await get(child(ref(db), 'bursluluk/students'));
        const students = snapshot.exists() ? Object.values(snapshot.val()) : [];
        
        let html = '';
        for(let i=0; i < window.selectedExam.seansCount; i++) {
            const date = window.selectedExam.dates[i] || window.selectedExam.dates[0] || "Tarih Yok";
            const time = window.selectedExam.times[i] || window.selectedExam.times[0] || "Saat Yok";
            const maxQuota = window.selectedExam.quotas[i] || 50;
            
            const registeredCount = students.filter(s => 
                s.examName === window.selectedExam.name && s.sessionIndex === i
            ).length;

            const remaining = maxQuota - registeredCount;
            const btnState = remaining > 0 ? 
                `<button class="btn btn-primary btn-sm" onclick="selectSession(${i}, '${date}', '${time}', ${remaining})">Seç</button>` : 
                `<span class="badge bg-danger">Dolu</span>`;

            html += `<tr><td>${date}</td><td>${time}</td><td>${remaining} / ${maxQuota}</td><td>${btnState}</td></tr>`;
        }
        tbody.innerHTML = html;
    }

    window.selectSession = (idx, date, time, remaining) => {
        window.selectedSession = { index: idx, date: date, time: time, remaining: remaining };
        document.getElementById('confirmText').innerHTML = 
            `<b>Fenomen Çocuk Kulübü</b><br>${date} - ${time}<br><b>${window.selectedExam.name}</b><br>sınavına kayıt olmak istiyor musunuz?`;
        changeStep(2);
    }

    // --- TC & REGISTRATION ---
    window.checkTCAndProceed = async () => {
        const tc = document.getElementById('tcCheckInput').value;
        if(tc.length !== 11 || isNaN(tc)) {
            Swal.fire("Hata", "Lütfen geçerli 11 haneli T.C. Kimlik Numarası giriniz.", "warning");
            return;
        }

        const snapshot = await get(child(ref(db), 'bursluluk/students'));
        let isRegistered = false;
        if (snapshot.exists()) {
            Object.values(snapshot.val()).forEach(student => {
                if(student.tc === tc && student.examName === window.selectedExam.name) isRegistered = true;
            });
        }

        if(isRegistered) {
            Swal.fire({ title: "Zaten Kayıtlı!", text: "Bu sınava zaten kaydınız var.", icon: "info" }).then(() => returnToMain());
        } else {
            changeStep(4);
            setupPhoneMasks();
        }
    }

    function setupPhoneMasks() {
        document.querySelectorAll('.phone-mask').forEach(input => {
            input.addEventListener('input', function (e) {
                var x = e.target.value.replace(/\D/g, '').match(/(\d{0,3})(\d{0,3})(\d{0,2})(\d{0,2})/);
                e.target.value = !x[2] ? x[1] : '(' + x[1] + ') ' + x[2] + (x[3] ? ' ' + x[3] : '') + (x[4] ? ' ' + x[4] : '');
            });
        });
    }

    window.completeRegistration = async () => {
        const stdName = document.getElementById('stdName').value.trim();
        const stdSchool = document.getElementById('stdSchool').value.trim();
        const parentName = document.getElementById('parentName').value.trim();
        const phone1 = document.getElementById('phone1').value;
        const phone2 = document.getElementById('phone2').value;
        const tc = document.getElementById('tcCheckInput').value;

        if(stdName.split(' ').length < 2 || parentName.split(' ').length < 2 || phone1.length < 14) {
            Swal.fire("Eksik Bilgi", "Ad soyadlar en az 2 kelime, telefon tam olmalı.", "warning");
            return;
        }

        const snapshot = await get(child(ref(db), 'bursluluk/students'));
        const allStudents = snapshot.exists() ? Object.values(snapshot.val()) : [];
        const thisExamStudents = allStudents.filter(s => s.examName === window.selectedExam.name);
        const usedNumbers = thisExamStudents.map(s => parseInt(s.studentNo)).sort((a,b) => a-b);
        
        let assignedNo = window.selectedExam.startNo;
        for(let i = 0; i < usedNumbers.length; i++) {
            if(usedNumbers[i] === assignedNo) assignedNo++;
            else if (usedNumbers[i] > assignedNo) break;
        }

        const currentSessionCount = thisExamStudents.filter(s => s.sessionIndex === window.selectedSession.index).length;
        if(currentSessionCount >= window.selectedExam.quotas[window.selectedSession.index]) {
            Swal.fire("Üzgünüz", "Bu sırada kontenjan doldu.", "error");
            changeStep(1);
            return;
        }

        const newStudentRef = push(ref(db, 'bursluluk/students'));
        const studentData = {
            id: newStudentRef.key, tc, studentName: stdName, school: stdSchool, parentName, phone1, phone2,
            examName: window.selectedExam.name, examDate: window.selectedSession.date, examTime: window.selectedSession.time,
            sessionIndex: window.selectedSession.index, studentNo: assignedNo, regDate: new Date().toLocaleString()
        };

        await set(newStudentRef, studentData);
        document.getElementById('finalCardPreview').innerHTML = generateCardHTML(studentData);
        changeStep(5);
    }

    function generateCardHTML(data) {
        return `<div class="exam-card"><div class="exam-card-header">FENOMEN ÇOCUK KULÜBÜ GİRİŞ KARTI</div><div class="exam-card-body">
            <div class="exam-card-row"><span>Ad Soyad:</span> <strong>${data.studentName.toUpperCase()}</strong></div>
            <div class="exam-card-row"><span>Okul:</span> <strong>${data.school}</strong></div>
            <div class="exam-card-row"><span>T.C. No:</span> <strong>${data.tc}</strong></div>
            <div class="exam-card-row" style="background:#f9f9f9;"><span>Öğrenci No:</span> <strong style="color:red;">${data.studentNo}</strong></div>
            <div class="mt-2 text-center" style="border-top:1px solid #ddd;"><strong>${data.examName}</strong><br>${data.examDate} - ${data.examTime}</div>
            <div class="text-center mt-1 text-muted" style="font-size:9px;">Sınav Yeri: Fenomen Çocuk Kulübü</div></div></div>`;
    }

    // --- OTHER FEATURES ---
    window.openStudentInfo = () => new bootstrap.Modal(document.getElementById('infoModal')).show();
    window.searchStudentInfo = async () => {
        const key = document.getElementById('searchInfoInput').value.trim();
        const snapshot = await get(child(ref(db), 'bursluluk/students'));
        const resDiv = document.getElementById('studentInfoResult');
        if (!snapshot.exists()) { resDiv.innerHTML = "<div class='alert alert-warning'>Kayıt bulunamadı.</div>"; return; }
        
        const found = Object.values(snapshot.val()).filter(s => s.tc === key || s.studentNo.toString() === key);
        resDiv.innerHTML = found.length ? found.map(s => 
            `<div class="mb-3 border p-3 bg-light">${generateCardHTML(s)}<button class="btn btn-danger w-100 mt-2" onclick="cancelRegistration('${s.id}', '${s.studentName}')">Sınavı İptal Et</button></div>`
        ).join('') : "<div class='alert alert-warning'>Bulunamadı.</div>";
    }

    window.cancelRegistration = (id, name) => {
        Swal.fire({
            title: 'Silinsin mi?', html: `Onaylamak için yazın:<br><b>${name} sınav iptal</b>`, input: 'text', showCancelButton: true
        }).then(async (res) => {
            if (res.isConfirmed && res.value === `${name} sınav iptal`) {
                await remove(ref(db, `bursluluk/students/${id}`));
                Swal.fire("Silindi", "", "success");
                document.getElementById('studentInfoResult').innerHTML = "";
            } else if (res.isConfirmed) Swal.fire("Hata", "Yazı eşleşmedi.", "error");
        });
    }

    window.openAdminPanel = () => {
        Swal.fire({ title: 'Yönetici Şifresi', input: 'password', showCancelButton: true }).then((res) => {
            if (res.value === window.adminPassword) {
                document.getElementById('mainMenu').style.display = 'none';
                document.getElementById('adminPanel').style.display = 'block';
                fetchExamData();
                fetchAdminData();
            } else if (res.isConfirmed) Swal.fire("Hata", "Yanlış Şifre", "error");
        });
    }

    async function fetchAdminData() {
        const snapshot = await get(child(ref(db), 'bursluluk/students'));
        dbStudents = snapshot.exists() ? Object.values(snapshot.val()) : [];
        renderAdminTable();
    }

    function populateAdminExamFilter() {
        const sel = document.getElementById('adminExamFilter');
        sel.innerHTML = '<option value="all">Tüm Sınavlar</option>';
        window.examData.forEach(e => sel.innerHTML += `<option value="${e.name}">${e.name}</option>`);
    }

    window.renderAdminTable = () => {
        const filter = document.getElementById('adminExamFilter').value;
        const search = document.getElementById('adminSearch').value.toLowerCase();
        const tbody = document.getElementById('adminTableBody');
        tbody.innerHTML = "";
        
        dbStudents.filter(s => (filter === 'all' || s.examName === filter) && (s.studentName.toLowerCase().includes(search) || s.tc.includes(search)))
        .sort((a,b) => a.studentNo - b.studentNo)
        .forEach(s => {
            tbody.innerHTML += `<tr>
                <td><input type="checkbox" class="admin-chk" value="${s.id}"></td>
                <td>${s.studentNo}</td><td>${s.tc}</td><td>${s.studentName}</td><td>${s.examName}</td><td>${s.examDate} ${s.examTime}</td>
                <td><button class="btn btn-sm btn-info" onclick="printSingleCard('${s.id}')"><i class="fas fa-print"></i></button></td>
            </tr>`;
        });
    }

    window.toggleSelectAll = () => document.querySelectorAll('.admin-chk').forEach(c => c.checked = document.getElementById('selectAll').checked);
    window.printSingleCard = (id) => {
        document.getElementById('printArea').innerHTML = `<div style="display:flex; justify-content:center; margin-top:50px;">${generateCardHTML(dbStudents.find(x => x.id === id))}</div>`;
        window.print();
        document.getElementById('printArea').innerHTML = "";
    }
    window.printBulkCards = () => {
        const checked = Array.from(document.querySelectorAll('.admin-chk:checked')).map(c => c.value);
        if(!checked.length) return Swal.fire("Seçim Yapın", "", "warning");
        document.getElementById('printArea').innerHTML = `<div class="print-grid">${dbStudents.filter(s => checked.includes(s.id)).map(s => `<div style="border:1px dashed #ccc;">${generateCardHTML(s)}</div>`).join('')}</div>`;
        window.print();
        document.getElementById('printArea').innerHTML = "";
    }
    window.printList = () => {
        const checked = Array.from(document.querySelectorAll('.admin-chk:checked')).map(c => c.value);
        const list = checked.length ? dbStudents.filter(s => checked.includes(s.id)) : dbStudents;
        document.getElementById('printArea').innerHTML = `<table border="1" style="width:100%; border-collapse:collapse;"><thead><tr><th>No</th><th>TC</th><th>Ad</th><th>Okul</th><th>Tel</th><th>Sınav</th></tr></thead><tbody>${list.map(s => `<tr><td>${s.studentNo}</td><td>${s.tc}</td><td>${s.studentName}</td><td>${s.school}</td><td>${s.phone1}</td><td>${s.examName}</td></tr>`).join('')}</tbody></table>`;
        window.print();
        document.getElementById('printArea').innerHTML = "";
    }
    window.bulkDelete = async () => {
        const checked = Array.from(document.querySelectorAll('.admin-chk:checked')).map(c => c.value);
        if(!checked.length) return Swal.fire("Seçim Yapın", "", "warning");
        if((await Swal.fire({ title: 'Emin misiniz?', icon: 'warning', showCancelButton: true })).isConfirmed) {
            const updates = {}; checked.forEach(id => updates[`bursluluk/students/${id}`] = null);
            await update(ref(db), updates);
            Swal.fire("Silindi", "", "success");
            fetchAdminData();
        }
    }
    
    // Yükleme Başlat
    fetchExamData();
</script>
</body>
</html>
