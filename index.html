<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fenomen Eğitim Kurumları - Bursluluk & LGS Provası</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>

  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root{
      --bg:#f8fafc;
      --ink:#0f172a;
      --muted:#64748b;
      --brand:#f97316;      /* Turuncu ana renk */
      --brand2:#fb923c;
      --ok:#16a34a;
      --warn:#f59e0b;
      --bad:#ef4444;
      --cardShadow: 0 10px 30px rgba(2, 6, 23, .10);
    }
    body{font-family:'Poppins',sans-serif;background:linear-gradient(180deg,#ffffff 0%, var(--bg) 60%);color:var(--ink);min-height:100vh;display:flex;flex-direction:column;}
    .hero-section{text-align:center;padding:52px 16px;flex:1;}
    .brand-badge{
      display:inline-flex;align-items:center;gap:10px;
      padding:10px 14px;border-radius:999px;
      background:rgba(249,115,22,.08);color:var(--brand);
      font-weight:600;
    }
    .main-btn{
      width:100%;height:124px;font-size:1.2rem;border-radius:18px;
      border:none;color:#fff;box-shadow:var(--cardShadow);
      transition:transform .15s ease, box-shadow .15s ease;
      display:flex;flex-direction:column;align-items:center;justify-content:center;gap:10px;
    }
    .main-btn:hover{transform:translateY(-3px);box-shadow:0 16px 40px rgba(2,6,23,.14);}
    .btn-new{background:linear-gradient(135deg,#f97316 0%, #fb923c 100%);}
    .btn-info{background:linear-gradient(135deg,#0f766e 0%, #22c55e 100%);}
    .btn-admin{background:linear-gradient(135deg,#7c3aed 0%, #6d28d9 100%);}

    .footer-credit{text-align:center;padding:20px 0;font-size:1.1rem;font-weight:600;color:var(--brand);background:rgba(249,115,22,.05);}

    /* Wizard ve diğer stiller aynı kaldı (kısaltmak için) */
    .wizard-shell{max-width:980px;margin:0 auto 56px;}
    .wizard-card{border:0;border-radius:18px;box-shadow:var(--cardShadow);background:#fff;overflow:hidden;}
    .wizard-head{padding:18px;background:linear-gradient(135deg,var(--brand),var(--brand2));color:#fff;}
    .step-pill{background:rgba(255,255,255,.18);border:1px solid rgba(255,255,255,.25);}
    .step-pill.active{background:#fff;color:var(--brand);}
    .ai-alert{border:1px solid rgba(249,115,22,.18);background:linear-gradient(180deg,rgba(249,115,22,.06),rgba(251,146,60,.04));}

    /* Yeni turuncu kart tasarımı */
    .exam-card{
      width:90mm;height:55mm;border-radius:16px;
      background:linear-gradient(135deg,#fff8f0,#ffffff);
      border:2px solid #f97316;
      box-shadow:0 12px 32px rgba(249,115,22,.25);
      padding:12px;position:relative;overflow:hidden;
    }
    .exam-card-header{
      display:flex;align-items:center;justify-content:space-between;
      background:var(--brand);color:#fff;padding:8px 12px;border-radius:12px;
    }
    .card-title{font-size:13px;font-weight:800;}
    .card-type{font-size:11px;font-weight:700;background:rgba(255,255,255,.2);padding:3px 8px;border-radius:999px;}
    .exam-card-body{margin-top:12px;display:grid;gap:8px;}
    .kv{display:grid;grid-template-columns:80px 1fr;gap:8px;font-size:11px;}
    .kv .k{color:var(--muted);font-weight:700;}
    .kv .v{font-weight:800;color:var(--ink);}
    .kv.name .v{font-size:14px;font-weight:900;color:var(--brand);}
    .big-no{background:rgba(249,115,22,.12);border:1px solid rgba(249,115,22,.3);border-radius:12px;padding:10px;text-align:center;}
    .big-no strong{font-size:24px;font-weight:900;color:var(--brand);}
    .exam-card-footer{margin-top:10px;padding-top:8px;border-top:1px dashed rgba(249,115,22,.4);font-size:10px;color:var(--muted);}
    .exam-card-footer .fr-k{font-weight:900;color:var(--ink);text-transform:uppercase;}
    .exam-card-footer .fr-v.exam-name{font-size:12px;font-weight:900;color:var(--brand);}

    @media screen{
      .exam-card{width:min(92vw,520px);height:auto;aspect-ratio:90/55;padding:14px;}
      .kv .v{font-size:13px;}
      .big-no strong{font-size:28px;}
    }
    @media print{
      .exam-card{width:90mm;height:55mm;box-shadow:none;}
      body{background:white;}
    }

    /* Siyah-beyaz toplu kart için */
    @media print{
      .exam-card-bw{
        border:2px solid #000 !important;
        background:white !important;
        box-shadow:none !important;
      }
      .exam-card-bw *{color:#000 !important;}
      .exam-card-bw .exam-card-header{background:#000 !important;color:#fff !important;}
      .exam-card-bw .big-no{background:#f0f0f0 !important;border-color:#000 !important;}
    }

    #loadingOverlay{position:fixed;inset:0;background:rgba(255,255,255,.92);z-index:9999;display:none;align-items:center;justify-content:center;flex-direction:column;backdrop-filter:blur(4px);}
  </style>
</head>
<body>

  <div id="loadingOverlay">
    <div class="spinner-border text-primary" role="status"></div>
    <div class="mt-3 fw-semibold">İşleniyor, lütfen bekleyiniz...</div>
  </div>

  <!-- ANA MENÜ -->
  <div class="container hero-section" id="mainMenu">
    <div class="brand-badge mb-3">
      <i class="fa-solid fa-graduation-cap"></i>
      <span>Fenomen Eğitim Kurumları</span>
    </div>
    <h1 class="mb-2" style="font-weight:800;color:var(--brand);">Bursluluk / LGS Provası Başvuru</h1>
    <div class="text-secondary mb-5">Başvuru, sorgulama ve yönetim işlemleri</div>

    <div class="row g-4 justify-content-center">
      <div class="col-md-4">
        <button class="main-btn btn-new" onclick="startNewRegistration()">
          <i class="fa-solid fa-user-plus fa-2x"></i>
          <div style="font-weight:700;">Yeni Kayıt</div>
          <div class="wizard-sub">Sınav seç, seans seç, kaydı tamamla</div>
        </button>
      </div>
      <div class="col-md-4">
        <button class="main-btn btn-info" onclick="openStudentInfo()">
          <i class="fa-solid fa-magnifying-glass fa-2x"></i>
          <div style="font-weight:700;">Kayıtlı Bilgisi</div>
          <div class="wizard-sub">TC / Öğrenci No ile sorgula ve iptal et</div>
        </button>
      </div>
      <div class="col-md-4">
        <button class="main-btn btn-admin" onclick="openAdminPanel()">
          <i class="fa-solid fa-user-shield fa-2x"></i>
          <div style="font-weight:700;">Yönetici Bölümü</div>
        </button>
      </div>
    </div>
  </div>

  <div class="footer-credit">
    Bu programı tasarlayan ve dizayn eden <strong>Ferhat Karagöz</strong>
  </div>

  <!-- WIZARD (değişiklik yok, aynı kalıyor) -->
  <!-- ... (wizard kısmı aynı, sadece kart generate fonksiyonu değişti) ... -->

  <!-- ÖĞRENCİ BİLGİSİ MODAL (Modernize edildi) -->
  <div class="modal fade" id="infoModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content border-0 shadow-lg" style="border-radius:20px;overflow:hidden;">
        <div class="modal-header text-white" style="background:linear-gradient(135deg,#22c55e,#16a34a);">
          <h5 class="modal-title fw-bold"><i class="fa-solid fa-magnifying-glass me-2"></i>Öğrenci Kayıt Sorgulama</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body p-4">
          <div class="row g-3 align-items-end">
            <div class="col-12 col-md-8">
              <label class="form-label fw-semibold">T.C. Kimlik veya Öğrenci No</label>
              <input type="text" class="form-control form-control-lg text-center" id="searchInfoInput" maxlength="11" inputmode="numeric" placeholder="___________" autocomplete="off">
              <div class="text-muted small mt-1">11 haneli T.C. veya öğrenci numarası giriniz</div>
            </div>
            <div class="col-12 col-md-4">
              <button class="btn btn-primary btn-lg w-100" onclick="searchStudentInfo()">
                <i class="fa-solid fa-magnifying-glass me-2"></i>Sorgula
              </button>
            </div>
          </div>
          <hr class="my-4">
          <div id="studentInfoResult"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ADMIN PANEL (Veli ve telefon eklendi, seans filtresi dinamik) -->
  <!-- ... (admin panel kısmı aynı, sadece tabloya veli ve telefon sütunu eklendi) ... -->

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref, set, get, child, update, remove, runTransaction, push } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAIzu6aNQstwQCdMWODyIwiaVVBm63OeGw",
      authDomain: "odevfeno.firebaseapp.com",
      databaseURL: "https://odevfeno-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "odevfeno",
      storageBucket: "odevfeno.firebasestorage.app",
      messagingSenderId: "662757516934",
      appId: "1:662757516934:web:0042188832f63deb6fd307",
      measurementId: "G-4Q99NQRB38"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    window.examData = [];
    window.selectedExam = null;
    window.selectedSession = null;
    let dbStudents = [];

    const SHEET_ID = "1oJGMO7FOPV4U86peeA63lmMk-wVCKsfWuyw2yefMweg";
    const GVIZ_CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=Bursluluk-Lgs`;

    const ADMIN_PASSWORD_SHA256_HEX = "0a0667865bc17f9d624bcf11088057bbab46336e7dae65f3d5366f4f7a18333e";

    // Helper fonksiyonlar (aynı)

    // Google Sheet verilerini çek ve sessions array oluştur
    window.fetchExamData = async function(isShowAlert=false){
      if(isShowAlert) showLoading(true);
      // ... PapaParse kısmı aynı ...

      window.examData = rows.map(row => {
        // ... aynı parse ...
        const sessions = [];
        for(let i=0; i<seansCount; i++){
          sessions.push({
            date: ex.dates[i] || "",
            time: ex.times[i] || "",
            maxQuota: ex.quotas[i] || 0
          });
        }
        return {name, key: slugifyTR(name), sessions, startNo};
      }).filter(Boolean);

      populateExamDropdown();
      populateAdminFilters();
      if(isShowAlert) showLoading(false);
      return true;
    };

    function populateAdminFilters(){
      const examSel = el("adminExamFilter");
      examSel.innerHTML = '<option value="all">Tüm Sınavlar</option>';
      window.examData.forEach(ex => {
        examSel.innerHTML += `<option value="${ex.key}">${ex.name}</option>`;
      });

      const sesSel = el("adminSessionFilter");
      sesSel.innerHTML = '<option value="all">Tüm Seanslar</option>';
      sesSel.disabled = true;

      examSel.addEventListener("change", () => {
        const key = examSel.value;
        sesSel.innerHTML = '<option value="all">Tüm Seanslar</option>';
        if(key === "all"){
          sesSel.disabled = true;
        }else{
          const ex = window.examData.find(e=>e.key===key);
          ex.sessions.forEach((s,i)=>{
            const used = /* gerçek zamanlı kullanılabilir */ 0; // render sırasında zaten var
            sesSel.innerHTML += `<option value="${s.time}">${s.date} • ${s.time}</option>`;
          });
          sesSel.disabled = false;
        }
        renderAdminTable();
      });
    }

    // Yeni turuncu kart HTML
    function generateCardHTML(s, bw=false){
      const cls = bw ? "exam-card exam-card-bw" : "exam-card";
      return `
        <div class="${cls}">
          <div class="exam-card-header">
            <div class="d-flex align-items-center gap-3">
              <div style="width:28px;height:28px;background:var(--brand);border-radius:8px;"></div>
              <div class="card-title">Fenomen Eğitim</div>
            </div>
            <div class="card-type">GİRİŞ KARTI</div>
          </div>
          <div class="exam-card-body">
            <div class="kv name">
              <div class="k">Ad Soyad</div>
              <div class="v">${escapeHtml(s.studentName)}</div>
            </div>
            <div class="kv">
              <div class="k">T.C.</div>
              <div class="v">${s.tc}</div>
            </div>
            <div class="big-no">
              <span>ÖĞRENCİ NO</span>
              <strong>${s.studentNo}</strong>
            </div>
            <div class="kv">
              <div class="k">Sınav</div>
              <div class="v exam-name">${escapeHtml(s.examName)}</div>
            </div>
            <div class="kv">
              <div class="k">Tarih • Saat</div>
              <div class="v">${escapeHtml(s.examDate)} • ${escapeHtml(s.examTime)}</div>
            </div>
            <div class="kv">
              <div class="k">Yer</div>
              <div class="v">Fenomen Eğitim Kurumları</div>
            </div>
          </div>
        </div>
      `;
    }

    // Vazgeç modalı input düzeltme
    window.cancelRegistration = async (id, studentName) => {
      // ... aynı kod ...
      const res = await Swal.fire({
        // ... aynı ...
        didOpen: () => {
          const input = Swal.getInput();
          if(input) input.focus();
        },
        // ...
      });
      // ...
    };

    // Toplu kart bas (siyah-beyaz)
    window.printBulkCards = async () => {
      const ids = selectedAdminIds();
      if(!ids.length) return Swal.fire("Uyarı","Seçili kayıt yok","warning");
      const selected = dbStudents.filter(s=>ids.includes(s.id));
      const body = `
        <div class="a4">
          <h2 class="title">Toplu Giriş Kartı</h2>
          <div class="cards-grid">
            ${selected.map(s => `<div class="card-cell">${generateCardHTML(s,true)}</div>`).join("")}
          </div>
        </div>
      `;
      const w = openPrintWindow("Toplu Kart", body);
      if(w) { w.focus(); w.print(); }
    };

    // Diğer çıktı fonksiyonları aynı (çalışır halde)

    // İlk yükleme
    fetchExamData(false);
  </script>
</body>
</html>
