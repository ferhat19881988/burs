<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fenomen Eğitim Kurumları - Sınav Başvuru</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #4e73df;
            --secondary-color: #858796;
            --success-color: #1cc88a;
            --danger-color: #e74a3b;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f8f9fc;
            background-image: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }

        .main-container {
            max-width: 1000px;
            margin: 50px auto;
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }

        /* Ana Menü Butonları */
        .big-btn {
            height: 150px;
            font-size: 1.5rem;
            transition: all 0.3s;
            border: none;
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 10px;
            color: white;
        }
        .big-btn:hover { transform: translateY(-5px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .btn-new { background: linear-gradient(45deg, #4e73df, #224abe); }
        .btn-check { background: linear-gradient(45deg, #1cc88a, #13855c); }
        .btn-admin { background: linear-gradient(45deg, #36b9cc, #258391); }

        /* Wizard Steps */
        .step-section { display: none; animation: fadeIn 0.5s; }
        .step-section.active { display: block; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Exam Card Design */
        .exam-card {
            border: 2px solid #4e73df;
            border-radius: 10px;
            padding: 20px;
            background: white;
            position: relative;
            max-width: 500px;
            margin: 20px auto;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .exam-card-header {
            background: #4e73df;
            color: white;
            padding: 10px;
            border-radius: 8px 8px 0 0;
            text-align: center;
            font-weight: bold;
            margin: -20px -20px 15px -20px;
        }
        .exam-card-row { display: flex; justify-content: space-between; margin-bottom: 8px; border-bottom: 1px dashed #ddd; padding-bottom: 5px; }
        .exam-card-label { font-weight: 600; color: #555; }

        /* Admin Print Styles */
        @media print {
            body * { visibility: hidden; }
            #printableArea, #printableArea * { visibility: visible; }
            #printableArea { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none !important; }
            .page-break { page-break-after: always; }
            
            /* Kartvizit Baskı Düzeni (A4) */
            .batch-print-container {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
                padding: 10px;
            }
            .batch-card {
                border: 1px dashed #000;
                padding: 10px;
                page-break-inside: avoid;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>

<div class="container main-container">
    
    <div class="text-center mb-5">
        <h2 class="fw-bold text-primary">FENOMEN EĞİTİM KURUMLARI</h2>
        <h5 class="text-muted">Online Sınav Başvuru Sistemi</h5>
    </div>

    <div id="globalAlert" class="alert d-none" role="alert"></div>

    <div id="mainMenu" class="row g-4">
        <div class="col-md-4">
            <button class="big-btn btn-new w-100" onclick="app.startNewRegistration()">
                <i class="fas fa-user-plus fa-2x"></i> Yeni Kayıt
            </button>
        </div>
        <div class="col-md-4">
            <button class="big-btn btn-check w-100" onclick="app.showCheckStatus()">
                <i class="fas fa-search fa-2x"></i> Kayıtlı Bilgisi
            </button>
        </div>
        <div class="col-md-4">
            <button class="big-btn btn-admin w-100" onclick="app.openAdminAuth()">
                <i class="fas fa-user-shield fa-2x"></i> Yönetici
            </button>
        </div>
    </div>

    <div id="wizardContainer" class="d-none">
        <button class="btn btn-outline-secondary mb-3" onclick="app.goHome()"><i class="fas fa-arrow-left"></i> Ana Menü</button>
        
        <div id="step1" class="step-section">
            <h4 class="mb-4"><i class="fas fa-list"></i> Sınav Seçimi</h4>
            <div class="mb-3">
                <label class="form-label">Sınav Adı</label>
                <select id="examSelect" class="form-select" onchange="app.onExamSelect()">
                    <option value="">Seçiniz...</option>
                </select>
            </div>
            <div id="examDetailsArea" class="d-none">
                <div class="mb-3">
                    <label class="form-label">Tarih</label>
                    <select id="dateSelect" class="form-select"></select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Seans & Saat (Kontenjan Durumu)</label>
                    <select id="sessionSelect" class="form-select"></select>
                </div>
                <button class="btn btn-primary w-100" onclick="app.confirmExamSelection()">Devam Et <i class="fas fa-arrow-right"></i></button>
            </div>
        </div>

        <div id="step2" class="step-section">
            <h4 class="mb-4"><i class="fas fa-id-card"></i> Kimlik Kontrolü</h4>
            <div class="mb-3">
                <label class="form-label">Öğrenci TC Kimlik No</label>
                <input type="text" id="tcCheckInput" class="form-control" maxlength="11" placeholder="11 haneli TC giriniz">
            </div>
            <button class="btn btn-primary" onclick="app.checkTC()">Sorgula</button>
        </div>

        <div id="step3" class="step-section">
            <h4 class="mb-4"><i class="fas fa-edit"></i> Öğrenci Bilgileri</h4>
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label">Öğrenci Tam Adı</label>
                    <input type="text" id="stdName" class="form-control" placeholder="Ad Soyad">
                </div>
                <div class="col-md-6">
                    <label class="form-label">Okulu</label>
                    <input type="text" id="stdSchool" class="form-control" placeholder="Okul Adı">
                </div>
                <div class="col-md-12">
                    <label class="form-label">Veli Tam Adı</label>
                    <input type="text" id="parentName" class="form-control" placeholder="Veli Ad Soyad">
                </div>
                <div class="col-md-6">
                    <label class="form-label">Telefon 1 (Veli)</label>
                    <input type="text" id="phone1" class="form-control phone-mask" placeholder="(5XX) XXX XX XX">
                    <small class="text-danger">Bilgilendirme bu numaraya yapılacaktır.</small>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Telefon 2</label>
                    <input type="text" id="phone2" class="form-control phone-mask" placeholder="(5XX) XXX XX XX">
                </div>
            </div>
            <button class="btn btn-success w-100 mt-4 btn-lg" onclick="app.completeRegistration()">KAYDI TAMAMLA</button>
        </div>

        <div id="step4" class="step-section text-center">
            <div class="alert alert-success">
                <h4><i class="fas fa-check-circle"></i> Başvurunuz Alınmıştır!</h4>
                <p>Giriş kartınız aşağıdadır. Sınavdan 2 gün önce kurumdan teslim alabilirsiniz.</p>
            </div>
            <div id="finalCardDisplay"></div>
            <button class="btn btn-primary mt-3 no-print" onclick="window.print()">Çıktı Al (Örnek)</button>
            <button class="btn btn-secondary mt-3 no-print" onclick="location.reload()">Yeni İşlem</button>
        </div>
    </div>

    <div id="checkStatusContainer" class="d-none">
        <button class="btn btn-outline-secondary mb-3" onclick="app.goHome()"><i class="fas fa-arrow-left"></i> Ana Menü</button>
        <h4><i class="fas fa-search"></i> Başvuru Sorgulama</h4>
        <div class="input-group mb-3">
            <input type="text" id="searchQuery" class="form-control" placeholder="TC veya Öğrenci Numarası giriniz">
            <button class="btn btn-primary" onclick="app.searchStudent()">Ara</button>
        </div>
        <div id="searchResults"></div>
    </div>

    <div id="adminContainer" class="d-none">
        <div class="d-flex justify-content-between align-items-center mb-3 no-print">
            <button class="btn btn-outline-secondary" onclick="app.goHome()"><i class="fas fa-arrow-left"></i> Çıkış</button>
            <h4 class="m-0">Yönetici Paneli</h4>
            <div>
                 <button class="btn btn-success btn-sm" onclick="app.adminQuickAdd()"><i class="fas fa-plus"></i> Hızlı Kayıt</button>
                 <button class="btn btn-warning btn-sm" onclick="app.printAttendance()"><i class="fas fa-list-alt"></i> Yoklama Listesi</button>
                 <button class="btn btn-info btn-sm" onclick="app.printBatchCards()"><i class="fas fa-print"></i> Toplu Kart Bas</button>
            </div>
        </div>

        <div class="row mb-3 no-print">
            <div class="col-md-4">
                <select id="adminFilterExam" class="form-select" onchange="app.adminLoadData()"></select>
            </div>
            <div class="col-md-4">
                 <select id="adminFilterSession" class="form-select" onchange="app.adminLoadData()"><option value="all">Tüm Seanslar</option></select>
            </div>
            <div class="col-md-4">
                <input type="text" id="adminSearch" class="form-control" placeholder="Öğrenci Ara..." onkeyup="app.adminFilterTable()">
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-bordered table-hover" id="adminTable">
                <thead class="table-dark">
                    <tr>
                        <th>No</th>
                        <th>Ad Soyad</th>
                        <th>TC</th>
                        <th>Okul</th>
                        <th>Veli Tel</th>
                        <th>Sınav/Seans</th>
                        <th class="no-print">İşlem</th>
                    </tr>
                </thead>
                <tbody id="adminTableBody"></tbody>
            </table>
        </div>
    </div>

</div>

<div id="printableArea"></div>

<div class="modal fade" id="cancelModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Sınav İptali</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Kayıt silmek üzeresiniz. İşlemi onaylamak için lütfen aşağıdaki kutuya <strong><span id="cancelConfirmText"></span> sınav iptal</strong> yazınız.</p>
                <input type="text" id="cancelInput" class="form-control" placeholder="Örn: ali veli sınav iptal">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Vazgeç</button>
                <button type="button" class="btn btn-danger" onclick="app.executeCancellation()">Onayla ve Sil</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="quickAddModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">Hızlı Öğrenci Kaydı</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="quickAddForm"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
                <button type="button" class="btn btn-success" onclick="app.saveQuickAdd()">Kaydet</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

<script type="module">
    // --- FIREBASE CONFIG ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, push, onValue, query, orderByChild, equalTo, remove, get, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAIzu6aNQstwQCdMWODyIwiaVVBm63OeGw",
        authDomain: "odevfeno.firebaseapp.com",
        databaseURL: "https://odevfeno-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "odevfeno",
        storageBucket: "odevfeno.firebasestorage.app",
        messagingSenderId: "662757516934",
        appId: "1:662757516934:web:0042188832f63deb6fd307",
        measurementId: "G-4Q99NQRB38"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // --- STATE MANAGEMENT ---
    let examData = []; // Google Sheet'ten gelen ham veri
    let currentSelection = {
        examName: null,
        date: null,
        sessionIndex: null, // Seans sırası (0, 1...)
        sessionTime: null,
        quotaLimit: 0,
        startNumber: 0,
        tc: null
    };
    let studentToCancel = null; // Silinecek öğrenci ID

    // --- GOOGLE SHEETS DATA FETCH ---
    const SHEET_ID = '1oJGMO7FOPV4U86peeA63lmMk-wVCKsfWuyw2yefMweg';
    const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv`;

    async function fetchExamData() {
        return new Promise((resolve, reject) => {
            Papa.parse(SHEET_URL, {
                download: true,
                header: true,
                complete: function(results) {
                    console.log("Sheet Data:", results.data);
                    examData = results.data.filter(row => row['Sınav'] && row['Sınav'] !== "");
                    resolve(examData);
                },
                error: function(err) {
                    showAlert("Sınav verileri yüklenemedi. Lütfen internet bağlantınızı kontrol edin.", "danger");
                    reject(err);
                }
            });
        });
    }

    // --- UI HELPERS ---
    function showSection(sectionId) {
        document.getElementById('mainMenu').classList.add('d-none');
        document.getElementById('wizardContainer').classList.add('d-none');
        document.getElementById('checkStatusContainer').classList.add('d-none');
        document.getElementById('adminContainer').classList.add('d-none');
        
        // Hide wizard steps
        document.querySelectorAll('.step-section').forEach(el => el.classList.remove('active'));

        const target = document.getElementById(sectionId);
        if(target) target.classList.remove('d-none');
    }

    function goHome() {
        document.getElementById('mainMenu').classList.remove('d-none');
        document.getElementById('wizardContainer').classList.add('d-none');
        document.getElementById('checkStatusContainer').classList.add('d-none');
        document.getElementById('adminContainer').classList.add('d-none');
        document.getElementById('globalAlert').classList.add('d-none');
        // Reset forms
        document.querySelectorAll('input').forEach(i => i.value = '');
    }

    function showAlert(msg, type='warning') {
        const el = document.getElementById('globalAlert');
        el.className = `alert alert-${type}`;
        el.innerHTML = msg;
        el.classList.remove('d-none');
        setTimeout(() => el.classList.add('d-none'), 5000);
    }

    // --- WIZARD LOGIC ---
    
    // 1. Start & Populate Exams
    window.app.startNewRegistration = async function() {
        showSection('wizardContainer');
        document.getElementById('step1').classList.add('active');
        
        try {
            await fetchExamData();
            const select = document.getElementById('examSelect');
            select.innerHTML = '<option value="">Seçiniz...</option>';
            // Unique Exam Names
            const uniqueExams = [...new Set(examData.map(item => item['Sınav']))];
            uniqueExams.forEach(exam => {
                const opt = document.createElement('option');
                opt.value = exam;
                opt.textContent = exam;
                select.appendChild(opt);
            });
        } catch (e) {
            console.error(e);
        }
    };

    window.app.onExamSelect = function() {
        const examName = document.getElementById('examSelect').value;
        const detailsArea = document.getElementById('examDetailsArea');
        
        if (!examName) {
            detailsArea.classList.add('d-none');
            return;
        }

        // Seçilen sınavın verisini bul (Sheet'te her satır farklı sınav parametresi olabilir)
        // Burada basitlik adına ilk eşleşeni alıyoruz, fakat gelişmiş senaryoda tarih bazlı ayrım yapılabilir.
        const examRow = examData.find(e => e['Sınav'] === examName);
        if (!examRow) return;

        currentSelection.examName = examName;
        currentSelection.startNumber = parseInt(examRow['İlk numara']) || 1000;

        // Tarihler
        const dates = examRow['Tarih'].split(';');
        const dateSelect = document.getElementById('dateSelect');
        dateSelect.innerHTML = '';
        dates.forEach(d => {
            const opt = document.createElement('option');
            opt.value = d.trim();
            opt.textContent = d.trim();
            dateSelect.appendChild(opt);
        });

        // Seanslar, Saatler, Kontenjanlar
        const sessions = parseInt(examRow['Seans']);
        const quotas = examRow['Kontenjan'].split(';');
        const hours = examRow['Saatler'].split(';');

        const sessionSelect = document.getElementById('sessionSelect');
        sessionSelect.innerHTML = '';

        // Her seans için kontenjanı veritabanından kontrol etmemiz lazım
        // Asenkron olduğu için UI'yi "Yükleniyor" yapıp dolduracağız.
        sessionSelect.innerHTML = '<option>Kontenjanlar kontrol ediliyor...</option>';
        
        checkQuotasAndFill(examName, dates[0], sessions, quotas, hours);
        
        detailsArea.classList.remove('d-none');
    };

    async function checkQuotasAndFill(examName, date, sessionCount, quotas, hours) {
        const sessionSelect = document.getElementById('sessionSelect');
        sessionSelect.innerHTML = '';

        for (let i = 0; i < sessionCount; i++) {
            const time = hours[i] ? hours[i].trim() : 'Saatsiz';
            const maxQuota = parseInt(quotas[i]) || 0;
            
            // Firebase'den bu sınav+tarih+saat için kayıt sayısını al
            const q = query(ref(db, 'bursluluk'), orderByChild('examKey'), equalTo(`${examName}_${date}_${time}`));
            const snapshot = await get(q);
            const currentCount = snapshot.size; // Kayıt sayısı
            
            const remaining = maxQuota - currentCount;
            
            const opt = document.createElement('option');
            opt.value = i; // index
            opt.dataset.time = time;
            opt.dataset.quota = maxQuota;
            
            if (remaining <= 0) {
                opt.textContent = `${time} - (DOLDU)`;
                opt.disabled = true;
            } else {
                opt.textContent = `${time} - (Kalan: ${remaining})`;
            }
            sessionSelect.appendChild(opt);
        }
    }

    window.app.confirmExamSelection = function() {
        const sSelect = document.getElementById('sessionSelect');
        if (sSelect.value === "") { showAlert("Lütfen bir seans seçiniz"); return; }
        
        const selectedOpt = sSelect.options[sSelect.selectedIndex];
        currentSelection.date = document.getElementById('dateSelect').value;
        currentSelection.sessionIndex = sSelect.value;
        currentSelection.sessionTime = selectedOpt.dataset.time;
        currentSelection.quotaLimit = parseInt(selectedOpt.dataset.quota);

        const confirmMsg = `
            <strong>Fenomen Çocuk Kulübü</strong><br>
            Tarih: ${currentSelection.date}<br>
            Saat: ${currentSelection.sessionTime}<br>
            Sınav: ${currentSelection.examName}<br><br>
            Bu sınava kayıt olmak istiyor musunuz?
        `;
        
        // Custom Modal yerine basit confirm veya HTML içi geçiş
        // Modern "wizard" akışı için alert yerine bir sonraki adıma geçiş öncesi onay sorusu gibi davranalım.
        // Kullanıcı deneyimi için bir "Onay Modal"ı tetikleyelim.
        
        // Burada basitlik için JS confirm kullanmıyorum, UI'yı güncelliyorum.
        if(confirm(selectedOpt.dataset.time + " saatindeki sınava başvuruyu onaylıyor musunuz?")) {
             document.getElementById('step1').classList.remove('active');
             document.getElementById('step2').classList.add('active');
        }
    };

    // 2. TC Check
    window.app.checkTC = async function() {
        const tc = document.getElementById('tcCheckInput').value;
        if (tc.length !== 11 || isNaN(tc)) {
            showAlert("Lütfen geçerli 11 haneli bir TC giriniz.", "danger");
            return;
        }

        // Bu sınav için daha önce kaydı var mı?
        const examKey = `${currentSelection.examName}_${currentSelection.date}_${currentSelection.sessionTime}`;
        
        // TC sorgusu (tüm verilerde TC'yi ara, sonra examKey kontrol et)
        // Firebase kuralı: 'bursluluk' altında, orderByChild('tc') equalTo(tc)
        const q = query(ref(db, 'bursluluk'), orderByChild('tc'), equalTo(tc));
        
        try {
            const snapshot = await get(q);
            let alreadyRegistered = false;
            
            snapshot.forEach(child => {
                if (child.val().examKey === examKey) {
                    alreadyRegistered = true;
                }
            });

            if (alreadyRegistered) {
                showAlert("Bu öğrenci için seçilen sınava zaten kayıt oluşturulmuş.", "info");
                setTimeout(() => goHome(), 3000);
            } else {
                currentSelection.tc = tc;
                document.getElementById('step2').classList.remove('active');
                document.getElementById('step3').classList.add('active');
            }
        } catch (error) {
            console.error(error);
            showAlert("Sistem hatası.", "danger");
        }
    };

    // 3. Complete Registration
    window.app.completeRegistration = async function() {
        const stdName = document.getElementById('stdName').value.trim();
        const stdSchool = document.getElementById('stdSchool').value.trim();
        const parentName = document.getElementById('parentName').value.trim();
        const phone1 = document.getElementById('phone1').value.trim();
        const phone2 = document.getElementById('phone2').value.trim();

        // Validasyonlar
        let errors = [];
        if (stdName.split(' ').length < 2) errors.push("Öğrenci adı en az 2 kelime olmalıdır.");
        if (parentName.split(' ').length < 2) errors.push("Veli adı en az 2 kelime olmalıdır.");
        if (phone1.length < 10) errors.push("Telefon 1 eksik.");
        if (!stdSchool) errors.push("Okul bilgisi girilmedi.");

        if (errors.length > 0) {
            showAlert("Eksik Bilgiler:<br>" + errors.join("<br>"), "danger");
            return;
        }

        // Öğrenci Numarası Atama
        // Strateji: O sınavdaki tüm öğrencilerin numaralarını çek, sırala, boşluk bul veya sona ekle.
        const examKey = `${currentSelection.examName}_${currentSelection.date}_${currentSelection.sessionTime}`;
        const q = query(ref(db, 'bursluluk'), orderByChild('examKey'), equalTo(examKey));
        
        const snapshot = await get(q);
        let existingNumbers = [];
        snapshot.forEach(c => existingNumbers.push(c.val().studentNumber));
        
        existingNumbers.sort((a,b) => a - b);
        
        let assignedNo = currentSelection.startNumber;
        for (let i = 0; i < existingNumbers.length + 1; i++) {
            let candidate = currentSelection.startNumber + i;
            if (!existingNumbers.includes(candidate)) {
                assignedNo = candidate;
                break;
            }
        }

        // Firebase Kayıt
        const newStudent = {
            tc: currentSelection.tc,
            stdName: stdName.toUpperCase(),
            school: stdSchool.toUpperCase(),
            parentName: parentName.toUpperCase(),
            phone1: phone1,
            phone2: phone2,
            examName: currentSelection.examName,
            date: currentSelection.date,
            time: currentSelection.sessionTime,
            studentNumber: assignedNo,
            examKey: examKey,
            createdAt: new Date().toISOString()
        };

        const newRef = push(ref(db, 'bursluluk'));
        await set(newRef, newStudent);

        // UI Güncelleme
        document.getElementById('step3').classList.remove('active');
        document.getElementById('step4').classList.add('active');
        
        renderCard('finalCardDisplay', newStudent);
    };

    function renderCard(containerId, data) {
        const html = `
            <div class="exam-card">
                <div class="exam-card-header">FENOMEN ÇOCUK KULÜBÜ<br>SINAV GİRİŞ KARTI</div>
                <div class="exam-card-row">
                    <span class="exam-card-label">Öğrenci Adı:</span>
                    <span>${data.stdName}</span>
                </div>
                 <div class="exam-card-row">
                    <span class="exam-card-label">TC No:</span>
                    <span>${data.tc.substring(0,2)}*******${data.tc.substring(9)}</span>
                </div>
                <div class="exam-card-row">
                    <span class="exam-card-label">Okulu:</span>
                    <span>${data.school}</span>
                </div>
                 <div class="exam-card-row">
                    <span class="exam-card-label">Sınav:</span>
                    <span>${data.examName}</span>
                </div>
                <div class="exam-card-row">
                    <span class="exam-card-label">Tarih / Saat:</span>
                    <span>${data.date} / ${data.time}</span>
                </div>
                 <div class="exam-card-row" style="background:#f1f1f1; padding:5px;">
                    <span class="exam-card-label">ÖĞRENCİ NO:</span>
                    <span style="font-size:1.2rem; font-weight:bold;">${data.studentNumber}</span>
                </div>
                <div class="text-center mt-3 text-muted" style="font-size:0.8rem;">
                    Sınav Yeri: Fenomen Çocuk Kulübü<br>
                    (Lütfen sınav saatinden 15 dk önce geliniz.)
                </div>
            </div>
        `;
        document.getElementById(containerId).innerHTML = html;
        // Print area için de hazırla
        document.getElementById('printableArea').innerHTML = html;
    }

    // --- CHECK STATUS & CANCEL ---
    window.app.showCheckStatus = function() {
        showSection('checkStatusContainer');
        document.getElementById('searchResults').innerHTML = '';
        document.getElementById('searchQuery').value = '';
    };

    window.app.searchStudent = async function() {
        const val = document.getElementById('searchQuery').value.trim();
        if(!val) return;

        const resultsDiv = document.getElementById('searchResults');
        resultsDiv.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Aranıyor...</div>';

        // Hem TC hem Öğrenci No ile arama yapılmalı. Firebase NoSQL olduğu için iki ayrı sorgu veya client-side filtre.
        // Client-side filtre (veri çok büyük değilse) veya iki ayrı query.
        // Basitlik için tüm veriyi çekip filtrelemek yerine, index'li alan (TC) üzerinden gidelim.
        // Eğer numara girildiyse (kısa ise) studentNumber, uzunsa (11) TC varsayalım.
        
        let q;
        if(val.length === 11) {
            q = query(ref(db, 'bursluluk'), orderByChild('tc'), equalTo(val));
        } else {
            // studentNumber sayı olarak saklanıyor
            q = query(ref(db, 'bursluluk'), orderByChild('studentNumber'), equalTo(parseInt(val)));
        }

        const snapshot = await get(q);
        resultsDiv.innerHTML = '';

        if (!snapshot.exists()) {
             resultsDiv.innerHTML = '<div class="alert alert-warning">Kayıt bulunamadı.</div>';
             return;
        }

        snapshot.forEach(child => {
            const data = child.val();
            const key = child.key;
            
            const cardId = `card_${key}`;
            const div = document.createElement('div');
            div.innerHTML = `
                <div id="${cardId}"></div>
                <div class="text-center mb-5">
                     <button class="btn btn-danger btn-sm" onclick="app.initiateCancel('${key}', '${data.stdName}', '${data.examName}')">
                        <i class="fas fa-times"></i> Sınava Girmekten Vazgeçtim
                     </button>
                     <button class="btn btn-primary btn-sm" onclick="app.printSingleCard('${key}')"><i class="fas fa-print"></i> Yazdır</button>
                </div>
                <hr>
            `;
            resultsDiv.appendChild(div);
            renderCard(cardId, data);
            
            // Print fonksiyonu için datayı sakla
            div.dataset.json = JSON.stringify(data);
        });
    };
    
    window.app.printSingleCard = function(key) {
        const cardHtml = document.getElementById(`card_${key}`).innerHTML;
        document.getElementById('printableArea').innerHTML = `<div style="margin:50px;">${cardHtml}</div>`;
        window.print();
    }

    window.app.initiateCancel = function(key, name, exam) {
        studentToCancel = { key, name };
        document.getElementById('cancelConfirmText').textContent = name;
        document.getElementById('cancelInput').value = '';
        const modal = new bootstrap.Modal(document.getElementById('cancelModal'));
        modal.show();
    };

    window.app.executeCancellation = async function() {
        const input = document.getElementById('cancelInput').value;
        const expected = `${studentToCancel.name} sınav iptal`; // Case sensitive? Prompt says "tam adınızı yazın"
        
        // Küçük harf toleransı tanıyalım
        if (input.toLowerCase() === expected.toLowerCase()) {
            await remove(ref(db, `bursluluk/${studentToCancel.key}`));
            bootstrap.Modal.getInstance(document.getElementById('cancelModal')).hide();
            showAlert("Kayıt başarıyla silindi.", "success");
            window.app.searchStudent(); // Listeyi yenile
        } else {
            alert("Girdiğiniz metin hatalı. Silme işlemi yapılmadı.");
        }
    };

    // --- ADMIN PANEL ---
    window.app.openAdminAuth = function() {
        const pass = prompt("Yönetici Şifresi:");
        if (pass === "13579") {
            showSection('adminContainer');
            app.setupAdminFilters();
            app.adminLoadData();
        } else {
            showAlert("Hatalı Şifre!", "danger");
        }
    };

    window.app.setupAdminFilters = async function() {
         await fetchExamData(); // Ensure data
         const select = document.getElementById('adminFilterExam');
         select.innerHTML = '<option value="all">Tüm Sınavlar</option>';
         const uniqueExams = [...new Set(examData.map(item => item['Sınav']))];
         uniqueExams.forEach(e => {
             select.innerHTML += `<option value="${e}">${e}</option>`;
         });
    };

    let allStudentsCache = [];

    window.app.adminLoadData = async function() {
        const tbody = document.getElementById('adminTableBody');
        tbody.innerHTML = '<tr><td colspan="7">Yükleniyor...</td></tr>';
        
        const snapshot = await get(ref(db, 'bursluluk'));
        allStudentsCache = [];
        snapshot.forEach(c => allStudentsCache.push({key: c.key, ...c.val()}));

        app.adminFilterTable();
    };

    window.app.adminFilterTable = function() {
        const examFilter = document.getElementById('adminFilterExam').value;
        const search = document.getElementById('adminSearch').value.toLowerCase();

        const filtered = allStudentsCache.filter(s => {
            const matchExam = examFilter === 'all' || s.examName === examFilter;
            const matchSearch = s.stdName.toLowerCase().includes(search) || s.tc.includes(search) || s.studentNumber.toString().includes(search);
            return matchExam && matchSearch;
        });
        
        // Sırala (Öğrenci No)
        filtered.sort((a,b) => a.studentNumber - b.studentNumber);

        const tbody = document.getElementById('adminTableBody');
        tbody.innerHTML = '';
        filtered.forEach(s => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${s.studentNumber}</td>
                <td>${s.stdName}</td>
                <td>${s.tc}</td>
                <td>${s.school}</td>
                <td>${s.phone1}</td>
                <td>${s.examName} / ${s.time}</td>
                <td class="no-print">
                    <button class="btn btn-danger btn-sm" onclick="app.adminDelete('${s.key}')"><i class="fas fa-trash"></i></button>
                    <button class="btn btn-primary btn-sm" onclick="app.printSingleCardKey('${s.key}')"><i class="fas fa-print"></i></button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    };
    
    window.app.printSingleCardKey = function(key) {
        const data = allStudentsCache.find(s => s.key === key);
        renderCard('printableArea', data);
        window.print();
    }
    
    window.app.adminDelete = async function(key) {
        if(confirm("Bu kaydı silmek istediğinize emin misiniz?")) {
            await remove(ref(db, `bursluluk/${key}`));
            app.adminLoadData();
        }
    };

    // --- ADMIN: PRINT OPERATIONS ---
    window.app.printAttendance = function() {
        // Tabloyu yazdıracağız sadece
        const content = document.getElementById('adminTable').outerHTML;
        const title = `<h3 class="text-center">Sınav Yoklama Listesi</h3><br>`;
        document.getElementById('printableArea').innerHTML = title + content;
        window.print();
    };

    window.app.printBatchCards = function() {
        // Filtrelenmiş listeyi al
        const examFilter = document.getElementById('adminFilterExam').value;
        const search = document.getElementById('adminSearch').value.toLowerCase();
        const filtered = allStudentsCache.filter(s => {
            const matchExam = examFilter === 'all' || s.examName === examFilter;
            const matchSearch = s.stdName.toLowerCase().includes(search);
            return matchExam && matchSearch;
        });

        let html = '<div class="batch-print-container">';
        filtered.forEach(data => {
            html += `
            <div class="batch-card">
                 <div style="text-align:center; font-weight:bold; border-bottom:1px solid #000; margin-bottom:5px;">FENOMEN ÇOCUK KULÜBÜ<br>SINAV GİRİŞ KARTI</div>
                <div><strong>Ad:</strong> ${data.stdName}</div>
                <div><strong>TC:</strong> ${data.tc}</div>
                <div><strong>Okul:</strong> ${data.school}</div>
                <div><strong>Sınav:</strong> ${data.examName}</div>
                <div><strong>Zaman:</strong> ${data.date} - ${data.time}</div>
                <div style="font-size:14px; font-weight:bold; text-align:right; margin-top:5px;">NO: ${data.studentNumber}</div>
            </div>
            `;
        });
        html += '</div>';
        
        document.getElementById('printableArea').innerHTML = html;
        window.print();
    };
    
    // --- ADMIN: QUICK ADD ---
    window.app.adminQuickAdd = function() {
         const modal = new bootstrap.Modal(document.getElementById('quickAddModal'));
         // Modal içine basit form koy
         const formHtml = `
             <label>TC</label><input type="text" id="q_tc" class="form-control mb-2">
             <label>Ad Soyad</label><input type="text" id="q_name" class="form-control mb-2">
             <label>Okul</label><input type="text" id="q_school" class="form-control mb-2">
             <label>Veli Tel</label><input type="text" id="q_phone" class="form-control mb-2">
             <label>Sınav</label><select id="q_exam" class="form-control mb-2"></select>
             <label>Tarih</label><input type="text" id="q_date" class="form-control mb-2" placeholder="01.01.2026">
             <label>Saat</label><input type="text" id="q_time" class="form-control mb-2" placeholder="10:00-11:15">
             <label>Manuel No (Boşsa otomatik)</label><input type="number" id="q_no" class="form-control mb-2">
         `;
         document.getElementById('quickAddForm').innerHTML = formHtml;
         
         // Sınavları doldur
         const select = document.getElementById('q_exam');
         const uniqueExams = [...new Set(examData.map(item => item['Sınav']))];
         uniqueExams.forEach(e => select.innerHTML += `<option>${e}</option>`);

         modal.show();
    };

    window.app.saveQuickAdd = async function() {
        // Basit kaydetme mantığı
        const data = {
            tc: document.getElementById('q_tc').value,
            stdName: document.getElementById('q_name').value.toUpperCase(),
            school: document.getElementById('q_school').value.toUpperCase(),
            phone1: document.getElementById('q_phone').value,
            examName: document.getElementById('q_exam').value,
            date: document.getElementById('q_date').value,
            time: document.getElementById('q_time').value,
            studentNumber: parseInt(document.getElementById('q_no').value) || 0, // 0 ise backend mantığı gerekir ama burada admin manuel giriyor varsayalım veya random
            examKey: `${document.getElementById('q_exam').value}_${document.getElementById('q_date').value}_${document.getElementById('q_time').value}`,
            createdAt: new Date().toISOString()
        };

        if(data.studentNumber === 0) {
            // Basitçe rastgele atayalım hızlı kayıt için
            data.studentNumber = Math.floor(Math.random() * 1000) + 9000; 
        }

        await push(ref(db, 'bursluluk'), data);
        bootstrap.Modal.getInstance(document.getElementById('quickAddModal')).hide();
        app.adminLoadData();
        showAlert("Hızlı kayıt eklendi", "success");
    };

    // --- GLOBAL ---
    window.app.goHome = goHome;

    // Mask Logic (Simple)
    document.addEventListener('input', function (e) {
        if (e.target.classList.contains('phone-mask')) {
            let x = e.target.value.replace(/\D/g, '').match(/(\d{0,3})(\d{0,3})(\d{0,2})(\d{0,2})/);
            e.target.value = !x[2] ? x[1] : '(' + x[1] + ') ' + x[2] + (x[3] ? ' ' + x[3] : '') + (x[4] ? ' ' + x[4] : '');
        }
    });

    // Sayfa yüklenince data çek
    fetchExamData();

</script>

<script>
    // Module scope dışında global erişim için köprü (app nesnesini window'a bağladık module içinde)
    // Yukarıdaki type="module" scripti çalıştığında window.app kullanılabilir olacak.
</script>

</body>
</html>
