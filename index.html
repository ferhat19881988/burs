<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fenomen Eğitim Kurumları - Bursluluk & LGS Provası</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.css"></script>

    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f4f6f9; }
        .hero-section { text-align: center; padding: 50px 20px; }
        .main-btn {
            width: 100%; height: 120px; font-size: 1.5rem; border-radius: 15px;
            transition: transform 0.2s, box-shadow 0.2s; border: none; color: white;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .main-btn:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        .btn-new { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .btn-info { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
        .btn-admin { background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%); }
        
        /* Wizard Steps */
        .wizard-step { display: none; animation: fadeIn 0.5s; }
        .wizard-step.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Exam Card Preview */
        .exam-card {
            width: 85.6mm; height: 53.98mm; /* Standard ID Card Size */
            border: 1px solid #ccc; background: white; padding: 10px;
            position: relative; box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            margin: 0 auto; overflow: hidden; page-break-inside: avoid;
            background-image: url('https://www.transparenttextures.com/patterns/cubes.png'); /* Pattern example */
        }
        .exam-card-header { background: #d9534f; color: white; padding: 5px; text-align: center; font-size: 12px; font-weight: bold; border-radius: 4px; }
        .exam-card-body { font-size: 11px; margin-top: 5px; }
        .exam-card-row { display: flex; justify-content: space-between; margin-bottom: 2px; border-bottom: 1px dashed #eee; }
        .exam-card-label { font-weight: bold; color: #555; }

        /* Admin Print Styles */
        @media print {
            body * { visibility: hidden; }
            #printArea, #printArea * { visibility: visible; }
            #printArea { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none !important; }
            .page-break { page-break-after: always; }
            .print-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 10px; }
        }
        
        /* Loading Overlay */
        #loadingOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9); z-index: 9999;
            display: flex; justify-content: center; align-items: center;
            flex-direction: column; display: none;
        }
    </style>
</head>
<body>

<div id="loadingOverlay">
    <div class="spinner-border text-primary" role="status"></div>
    <div class="mt-2 fw-bold">Veriler Yükleniyor...</div>
</div>

<div class="container hero-section" id="mainMenu">
    <h1 class="mb-4 text-primary"><i class="fas fa-graduation-cap"></i> Fenomen Eğitim Kurumları</h1>
    <h4 class="mb-5 text-secondary">Bursluluk ve LGS Provası Başvuru Sistemi</h4>
    
    <div class="row g-4 justify-content-center">
        <div class="col-md-4">
            <button class="main-btn btn-new" onclick="startNewRegistration()">
                <i class="fas fa-user-plus fa-2x mb-2"></i> Yeni Kayıt
            </button>
        </div>
        <div class="col-md-4">
            <button class="main-btn btn-info" onclick="openStudentInfo()">
                <i class="fas fa-search fa-2x mb-2"></i> Kayıtlı Bilgisi
            </button>
        </div>
        <div class="col-md-4">
            <button class="main-btn btn-admin" onclick="openAdminPanel()">
                <i class="fas fa-user-shield fa-2x mb-2"></i> Yönetici Bölümü
            </button>
        </div>
    </div>
</div>

<div class="container mt-5" id="wizardContainer" style="display:none;">
    <div class="card shadow">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Sınav Kayıt İşlemleri</h5>
            <button class="btn btn-sm btn-light" onclick="returnToMain()">Ana Menü</button>
        </div>
        <div class="card-body">
            
            <div class="wizard-step active" id="step1">
                <h4 class="text-center mb-4">Lütfen Katılmak İstediğiniz Sınavı Seçiniz</h4>
                <div class="alert alert-info text-center" id="dataStatusAlert" style="display:none;"></div>
                <div class="d-flex justify-content-center mb-3">
                    <select class="form-select form-select-lg w-75" id="examSelect" onchange="loadExamDetails()">
                        <option value="">Sınav Seçiniz...</option>
                        </select>
                </div>
                <div id="examDetailsArea" class="mt-4" style="display:none;">
                    <table class="table table-hover">
                        <thead><tr><th>Tarih</th><th>Saat</th><th>Kalan Kontenjan</th><th>İşlem</th></tr></thead>
                        <tbody id="sessionTableBody"></tbody>
                    </table>
                </div>
            </div>

            <div class="wizard-step" id="step2">
                <div class="text-center">
                    <h3 class="text-primary mb-3">Seçim Onayı</h3>
                    <p class="lead" id="confirmText">...</p>
                    <hr>
                    <button class="btn btn-secondary btn-lg me-2" onclick="changeStep(1)">Hayır, Geri Dön</button>
                    <button class="btn btn-success btn-lg" onclick="changeStep(3)">Evet, Devam Et</button>
                </div>
            </div>

            <div class="wizard-step" id="step3">
                <div class="row justify-content-center">
                    <div class="col-md-6 text-center">
                        <label class="form-label">Öğrenci T.C. Kimlik Numarası</label>
                        <input type="text" class="form-control form-control-lg text-center" id="tcCheckInput" maxlength="11" placeholder="11 haneli TC giriniz">
                        <button class="btn btn-primary mt-3 w-100" onclick="checkTCAndProceed()">Sorgula ve Devam Et</button>
                    </div>
                </div>
            </div>

            <div class="wizard-step" id="step4">
                <h4 class="mb-3 border-bottom pb-2">Öğrenci ve Veli Bilgileri</h4>
                <form id="regForm" onsubmit="event.preventDefault(); completeRegistration();">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Öğrenci Adı Soyadı</label>
                            <input type="text" class="form-control" id="stdName" required minlength="5" placeholder="En az 2 kelime">
                            <div class="form-text">Ad ve Soyad arasında boşluk bırakınız.</div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Okulu</label>
                            <input type="text" class="form-control" id="stdSchool" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Veli Adı Soyadı</label>
                            <input type="text" class="form-control" id="parentName" required minlength="5">
                        </div>
                        <div class="col-md-6"></div> <div class="col-md-6">
                            <label class="form-label">Veli Telefon 1</label>
                            <input type="text" class="form-control phone-mask" id="phone1" placeholder="(5XX) XXX XX XX" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Veli Telefon 2</label>
                            <input type="text" class="form-control phone-mask" id="phone2" placeholder="(5XX) XXX XX XX">
                        </div>
                        <div class="col-12 alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i> Uyarı: Bilgilendirmeler telefon üzerinden yapılacaktır. Lütfen numaraları doğru girdiğinizden emin olunuz.
                        </div>
                    </div>
                    <div class="text-end mt-4">
                        <button type="submit" class="btn btn-success btn-lg">Kaydı Tamamla</button>
                    </div>
                </form>
            </div>

            <div class="wizard-step" id="step5">
                <div class="text-center">
                    <i class="fas fa-check-circle text-success fa-5x mb-3"></i>
                    <h2>Tebrikler! Başvurunuz Alınmıştır.</h2>
                    <p>Giriş kartınız basıma hazırlanmıştır. Sınavdan 2 gün önce kurumumuzdan teslim alabilirsiniz.</p>
                    <div class="d-flex justify-content-center mt-4">
                        <div id="finalCardPreview"></div>
                    </div>
                    <button class="btn btn-primary mt-4" onclick="returnToMain()">Ana Sayfaya Dön</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="infoModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">Öğrenci Kayıt Sorgulama</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="input-group mb-3">
                    <input type="text" class="form-control" id="searchInfoInput" placeholder="T.C. Kimlik veya Öğrenci No giriniz">
                    <button class="btn btn-primary" onclick="searchStudentInfo()">Sorgula</button>
                </div>
                <div id="studentInfoResult"></div>
            </div>
        </div>
    </div>
</div>

<div class="container mt-4" id="adminPanel" style="display:none;">
    <div class="card">
        <div class="card-header bg-dark text-white d-flex justify-content-between">
            <h4>Yönetici Paneli</h4>
            <button class="btn btn-sm btn-outline-light" onclick="returnToMain()">Çıkış</button>
        </div>
        <div class="card-body">
            <div class="row g-2 mb-3 no-print">
                <div class="col-md-3">
                    <select class="form-select" id="adminExamFilter" onchange="renderAdminTable()">
                        <option value="all">Tüm Sınavlar</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <input type="text" class="form-control" id="adminSearch" placeholder="Ara (Ad, TC, No)..." onkeyup="renderAdminTable()">
                </div>
                <div class="col-md-6 text-end">
                    <button class="btn btn-success btn-sm" onclick="adminQuickRegister()"><i class="fas fa-plus"></i> Hızlı Kayıt</button>
                    <button class="btn btn-primary btn-sm" onclick="printList()"><i class="fas fa-print"></i> Liste Çıktısı</button>
                    <button class="btn btn-warning btn-sm" onclick="printBulkCards()"><i class="fas fa-id-card"></i> Toplu Kart Bas</button>
                    <button class="btn btn-danger btn-sm" onclick="bulkDelete()"><i class="fas fa-trash"></i> Seçileni Sil</button>
                </div>
            </div>

            <div class="table-responsive">
                <table class="table table-bordered table-striped" id="adminTable">
                    <thead class="table-dark">
                        <tr>
                            <th><input type="checkbox" id="selectAll" onclick="toggleSelectAll()"></th>
                            <th>Öğrenci No</th>
                            <th>TC Kimlik</th>
                            <th>Ad Soyad</th>
                            <th>Sınav</th>
                            <th>Tarih/Saat</th>
                            <th>İşlemler</th>
                        </tr>
                    </thead>
                    <tbody id="adminTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div id="printArea"></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getDatabase, ref, set, get, child, update, remove, runTransaction, push } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

    // Firebase Config
    const firebaseConfig = {
        apiKey: "AIzaSyAIzu6aNQstwQCdMWODyIwiaVVBm63OeGw",
        authDomain: "odevfeno.firebaseapp.com",
        databaseURL: "https://odevfeno-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "odevfeno",
        storageBucket: "odevfeno.firebasestorage.app",
        messagingSenderId: "662757516934",
        appId: "1:662757516934:web:0042188832f63deb6fd307",
        measurementId: "G-4Q99NQRB38"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Global Variables
    window.examData = []; // From Google Sheet
    window.selectedExam = null;
    window.selectedSession = null; 
    window.adminPassword = "13579";
    let dbStudents = []; // Local cache of students for admin

    // --- GOOGLE SHEET PARSER ---
    window.fetchExamData = function(isShowAlert = false) {
        // Eğer gösterilecekse loading
        if(isShowAlert) document.getElementById('loadingOverlay').style.display = 'flex';
        
        const sheetId = "1oJGMO7FOPV4U86peeA63lmMk-wVCKsfWuyw2yefMweg";
        // 'Bursluluk-Lgs' sekmesi veya ilk sekme için gid=0 kullanıyoruz. 
        // Kullanıcının mutlaka yayınlama ayarında 'Bursluluk-Lgs' seçmesi gerekir.
        const csvUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv`;

        Papa.parse(csvUrl, {
            download: true,
            header: true,
            skipEmptyLines: true,
            complete: function(results) {
                if(isShowAlert) document.getElementById('loadingOverlay').style.display = 'none';

                // Kolon adı kontrolü ve Temizleme
                // Sınav, Tarih, Seans, Kontenjan, Saatler, İlk numara
                
                // Hata Kontrolü: Data boş mu?
                if (!results.data || results.data.length === 0) {
                    console.error("Google Sheet verisi boş döndü.");
                    if(isShowAlert) Swal.fire("Veri Hatası", "Tablodan veri çekilemedi. Lütfen 'Web'de Yayınla' ayarını kontrol ediniz.", "error");
                    return;
                }

                try {
                    window.examData = results.data.filter(row => row['Sınav'] && row['Sınav'] !== "").map(row => {
                        return {
                            name: row['Sınav'],
                            dates: row['Tarih'] ? row['Tarih'].split(';') : [],
                            seansCount: parseInt(row['Seans']),
                            quotas: row['Kontenjan'] ? row['Kontenjan'].split(';').map(Number) : [],
                            times: row['Saatler'] ? row['Saatler'].split(';') : [],
                            startNo: parseInt(row['İlk numara'])
                        };
                    });
                    
                    if(window.examData.length === 0) {
                         if(isShowAlert) Swal.fire("Veri Format Hatası", "Sütun isimleri (Sınav, Tarih vb.) eşleşmiyor olabilir. Tablo başlıklarını kontrol ediniz.", "warning");
                    } else {
                        console.log("Sınav Verileri Yüklendi:", window.examData);
                        populateExamDropdown();
                        populateAdminExamFilter();
                    }
                } catch (e) {
                    console.error("Veri işleme hatası:", e);
                    if(isShowAlert) Swal.fire("İşleme Hatası", "Veriler okunurken hata oluştu: " + e.message, "error");
                }
            },
            error: function(err) {
                if(isShowAlert) document.getElementById('loadingOverlay').style.display = 'none';
                console.error("PapaParse Hatası:", err);
                if(isShowAlert) Swal.fire("Bağlantı Hatası", "Google E-Tabloya erişilemedi. İnternet bağlantınızı kontrol ediniz.", "error");
            }
        });
    }

    // --- NAVIGATION ---
    window.startNewRegistration = () => {
        document.getElementById('mainMenu').style.display = 'none';
        document.getElementById('wizardContainer').style.display = 'block';
        changeStep(1);
        // Tıklayınca veriyi tekrar çekmeyi dene ve hata varsa göster
        fetchExamData(true); 
    }
    window.returnToMain = () => {
        document.getElementById('wizardContainer').style.display = 'none';
        document.getElementById('adminPanel').style.display = 'none';
        document.getElementById('mainMenu').style.display = 'block';
        document.getElementById('regForm').reset();
    }
    window.changeStep = (stepNo) => {
        document.querySelectorAll('.wizard-step').forEach(el => el.classList.remove('active'));
        document.getElementById(`step${stepNo}`).classList.add('active');
    }

    // --- STEP 1 & 2: EXAM SELECTION & QUOTA ---
    function populateExamDropdown() {
        const select = document.getElementById('examSelect');
        select.innerHTML = '<option value="">Sınav Seçiniz...</option>';
        if(window.examData.length === 0) {
             select.innerHTML += '<option disabled>Sınav bilgisi yüklenemedi...</option>';
        }
        window.examData.forEach((exam, index) => {
            select.innerHTML += `<option value="${index}">${exam.name}</option>`;
        });
    }

    window.loadExamDetails = async () => {
        const index = document.getElementById('examSelect').value;
        const area = document.getElementById('examDetailsArea');
        const tbody = document.getElementById('sessionTableBody');
        tbody.innerHTML = '<tr><td colspan="4">Kontenjanlar hesaplanıyor...</td></tr>';
        area.style.display = 'block';

        if(index === "") { area.style.display = 'none'; return; }
        
        window.selectedExam = window.examData[index];

        // Fetch current counts from Firebase
        const snapshot = await get(child(ref(db), 'bursluluk/students'));
        const students = snapshot.exists() ? Object.values(snapshot.val()) : [];
        
        let html = '';
        
        for(let i=0; i < window.selectedExam.seansCount; i++) {
            const date = window.selectedExam.dates[i] || window.selectedExam.dates[0] || "Tarih Yok";
            const time = window.selectedExam.times[i] || "Saat Yok";
            const maxQuota = window.selectedExam.quotas[i] || 999;

            // Count registered
            const registeredCount = students.filter(s => 
                s.examName === window.selectedExam.name && 
                s.sessionIndex === i
            ).length;

            const remaining = maxQuota - registeredCount;
            let btnState = "";
            
            if (remaining > 0) {
                btnState = `<button class="btn btn-primary btn-sm" onclick="selectSession(${i}, '${date}', '${time}', ${remaining})">Seç</button>`;
            } else {
                btnState = `<span class="badge bg-danger">Kontenjan Dolu</span>`;
            }

            html += `<tr>
                <td>${date}</td>
                <td>${time}</td>
                <td>${remaining > 0 ? remaining : 0} / ${maxQuota}</td>
                <td>${btnState}</td>
            </tr>`;
        }
        tbody.innerHTML = html;
    }

    window.selectSession = (idx, date, time, remaining) => {
        window.selectedSession = {
            index: idx,
            date: date,
            time: time,
            remaining: remaining
        };
        // Show confirm text
        document.getElementById('confirmText').innerHTML = 
            `<b>Fenomen Çocuk Kulübü</b><br> 
            ${date} tarihinde saat ${time} gerçekleşecek<br>
            <b>${window.selectedExam.name}</b><br>
            sınavına kayıt olmak istiyor musunuz?`;
        
        changeStep(2);
    }

    // --- STEP 3: TC CHECK ---
    window.checkTCAndProceed = async () => {
        const tc = document.getElementById('tcCheckInput').value.trim();
        if(tc.length !== 11 || isNaN(tc)) {
            Swal.fire("Hata", "Lütfen geçerli 11 haneli T.C. Kimlik Numarası giriniz.", "warning");
            return;
        }

        document.getElementById('loadingOverlay').style.display = 'flex';
        const snapshot = await get(child(ref(db), 'bursluluk/students'));
        document.getElementById('loadingOverlay').style.display = 'none';
        
        let isRegistered = false;
        if (snapshot.exists()) {
            const data = snapshot.val();
            // Check if TC exists for THIS exam
            Object.values(data).forEach(student => {
                if(student.tc === tc && student.examName === window.selectedExam.name) {
                    isRegistered = true;
                }
            });
        }

        if(isRegistered) {
            Swal.fire({
                title: "Zaten Kayıtlı!",
                text: "Bu T.C. numarası ile bu sınava daha önce başvurunuz alınmıştır.",
                icon: "info",
                confirmButtonText: "Ana Menüye Dön"
            }).then(() => returnToMain());
        } else {
            changeStep(4);
            setupPhoneMasks();
        }
    }

    function setupPhoneMasks() {
        const inputs = document.querySelectorAll('.phone-mask');
        inputs.forEach(input => {
            input.addEventListener('input', function (e) {
                var x = e.target.value.replace(/\D/g, '').match(/(\d{0,3})(\d{0,3})(\d{0,2})(\d{0,2})/);
                e.target.value = !x[2] ? x[1] : '(' + x[1] + ') ' + x[2] + (x[3] ? ' ' + x[3] : '') + (x[4] ? ' ' + x[4] : '');
            });
        });
    }

    // --- STEP 4 & 5: REGISTRATION LOGIC ---
    window.completeRegistration = async () => {
        // Form Validation
        const stdName = document.getElementById('stdName').value.trim();
        const stdSchool = document.getElementById('stdSchool').value.trim();
        const parentName = document.getElementById('parentName').value.trim();
        const phone1 = document.getElementById('phone1').value;
        const phone2 = document.getElementById('phone2').value;
        const tc = document.getElementById('tcCheckInput').value;

        let errors = [];
        if(stdName.split(' ').length < 2) errors.push("Öğrenci adı en az 2 kelime olmalıdır.");
        if(parentName.split(' ').length < 2) errors.push("Veli adı en az 2 kelime olmalıdır.");
        if(phone1.length < 14) errors.push("Telefon 1 eksik girildi.");

        if(errors.length > 0) {
            Swal.fire({
                title: "Eksik Bilgi",
                html: errors.join("<br>"),
                icon: "warning"
            });
            return;
        }

        document.getElementById('loadingOverlay').style.display = 'flex';

        // Logic: Calculate Student ID (Fill gaps logic)
        const snapshot = await get(child(ref(db), 'bursluluk/students'));
        const allStudents = snapshot.exists() ? Object.values(snapshot.val()) : [];
        const thisExamStudents = allStudents.filter(s => s.examName === window.selectedExam.name);
        
        // Extract Numbers and Sort
        const usedNumbers = thisExamStudents.map(s => parseInt(s.studentNo)).sort((a,b) => a-b);
        
        let assignedNo = window.selectedExam.startNo;
        // Find gap
        for(let i = 0; i < usedNumbers.length; i++) {
            if(usedNumbers[i] === assignedNo) {
                assignedNo++;
            } else if (usedNumbers[i] > assignedNo) {
                break;
            }
        }

        // Final Quota Check
        const currentSessionCount = thisExamStudents.filter(s => s.sessionIndex === window.selectedSession.index).length;
        const maxQ = window.selectedExam.quotas[window.selectedSession.index];
        
        if(currentSessionCount >= maxQ) {
            document.getElementById('loadingOverlay').style.display = 'none';
            Swal.fire("Üzgünüz", "İşlem sırasında kontenjan doldu. Lütfen başka seans seçiniz.", "error");
            changeStep(1);
            return;
        }

        // SAVE TO FIREBASE
        const newStudentRef = push(ref(db, 'bursluluk/students')); 
        const studentData = {
            id: newStudentRef.key,
            tc: tc,
            studentName: stdName,
            school: stdSchool,
            parentName: parentName,
            phone1: phone1,
            phone2: phone2,
            examName: window.selectedExam.name,
            examDate: window.selectedSession.date,
            examTime: window.selectedSession.time,
            sessionIndex: window.selectedSession.index,
            studentNo: assignedNo,
            regDate: new Date().toLocaleString()
        };

        await set(newStudentRef, studentData);
        document.getElementById('loadingOverlay').style.display = 'none';

        // Generate Card
        const cardHtml = generateCardHTML(studentData);
        document.getElementById('finalCardPreview').innerHTML = cardHtml;
        changeStep(5);
    }

    // Helper: Card Generator
    function generateCardHTML(data) {
        return `
        <div class="exam-card">
            <div class="exam-card-header">FENOMEN ÇOCUK KULÜBÜ GİRİŞ KARTI</div>
            <div class="exam-card-body">
                <div class="exam-card-row"><span>Ad Soyad:</span> <strong>${data.studentName.toUpperCase()}</strong></div>
                <div class="exam-card-row"><span>Okul:</span> <strong>${data.school}</strong></div>
                <div class="exam-card-row"><span>T.C. No:</span> <strong>${data.tc}</strong></div>
                <div class="exam-card-row" style="background:#f9f9f9;"><span>Öğrenci No:</span> <strong style="font-size:14px; color:red;">${data.studentNo}</strong></div>
                <div class="mt-2 text-center" style="border-top:1px solid #ddd; padding-top:2px;">
                    <strong>${data.examName}</strong><br>
                    Tarih: ${data.examDate} - Saat: ${data.examTime}
                </div>
                <div class="text-center mt-1 text-muted" style="font-size:9px;">Sınav Yeri: Fenomen Çocuk Kulübü</div>
            </div>
        </div>
        `;
    }

    // --- STUDENT INFO & CANCEL ---
    window.openStudentInfo = () => {
        new bootstrap.Modal(document.getElementById('infoModal')).show();
    }

    window.searchStudentInfo = async () => {
        const key = document.getElementById('searchInfoInput').value.trim();
        const resDiv = document.getElementById('studentInfoResult');
        resDiv.innerHTML = "Aranıyor...";

        const snapshot = await get(child(ref(db), 'bursluluk/students'));
        if (!snapshot.exists()) {
            resDiv.innerHTML = "<div class='alert alert-warning'>Kayıt bulunamadı.</div>";
            return;
        }

        const data = Object.values(snapshot.val());
        const found = data.filter(s => s.tc === key || s.studentNo.toString() === key);

        if(found.length === 0) {
            resDiv.innerHTML = "<div class='alert alert-warning'>Bu bilgilerle bir başvuru bulunamadı.</div>";
        } else {
            let html = '';
            found.forEach(s => {
                html += `<div class="mb-3 border p-3 rounded bg-light">
                    ${generateCardHTML(s)}
                    <button class="btn btn-danger w-100 mt-2" onclick="cancelRegistration('${s.id}', '${s.studentName}')">
                        <i class="fas fa-times"></i> Sınava Girmekten Vazgeçtim
                    </button>
                </div>`;
            });
            resDiv.innerHTML = html;
        }
    }

    window.cancelRegistration = (id, name) => {
        Swal.fire({
            title: 'Kaydı Silmek İstiyor musunuz?',
            html: `İşlemi onaylamak için aşağıya <br> <b>${name} sınav iptal</b> <br> yazınız.`,
            input: 'text',
            showCancelButton: true,
            confirmButtonText: 'Onayla ve Sil',
            cancelButtonText: 'Vazgeç',
            preConfirm: (text) => {
                if (text !== `${name} sınav iptal`) {
                    Swal.showValidationMessage('Yazı eşleşmedi, silme işlemi iptal edildi.');
                }
            }
        }).then(async (result) => {
            if (result.isConfirmed) {
                await remove(ref(db, `bursluluk/students/${id}`));
                Swal.fire("Silindi", "Kayıt başarıyla silindi.", "success");
                document.getElementById('studentInfoResult').innerHTML = ""; 
            }
        });
    }

    // --- ADMIN PANEL ---
    window.openAdminPanel = () => {
        Swal.fire({
            title: 'Yönetici Girişi',
            input: 'password',
            inputAttributes: { autocapitalize: 'off' },
            showCancelButton: true,
            confirmButtonText: 'Giriş',
            showLoaderOnConfirm: true,
            preConfirm: (login) => {
                if (login !== window.adminPassword) {
                    Swal.showValidationMessage('Hatalı Şifre');
                }
            }
        }).then((result) => {
            if (result.isConfirmed) {
                document.getElementById('mainMenu').style.display = 'none';
                document.getElementById('adminPanel').style.display = 'block';
                fetchExamData(); // Ensure exams are loaded for filter
                fetchAdminData();
            }
        })
    }

    async function fetchAdminData() {
        const snapshot = await get(child(ref(db), 'bursluluk/students'));
        dbStudents = snapshot.exists() ? Object.values(snapshot.val()) : [];
        renderAdminTable();
    }

    function populateAdminExamFilter() {
        const sel = document.getElementById('adminExamFilter');
        sel.innerHTML = '<option value="all">Tüm Sınavlar</option>';
        window.examData.forEach(e => {
            sel.innerHTML += `<option value="${e.name}">${e.name}</option>`;
        });
    }

    window.renderAdminTable = () => {
        const filterExam = document.getElementById('adminExamFilter').value;
        const search = document.getElementById('adminSearch').value.toLowerCase();
        const tbody = document.getElementById('adminTableBody');
        tbody.innerHTML = "";

        let filtered = dbStudents.filter(s => {
            let matchExam = filterExam === 'all' || s.examName === filterExam;
            let matchSearch = (s.studentName.toLowerCase().includes(search) || 
                               s.tc.includes(search) || 
                               s.studentNo.toString().includes(search));
            return matchExam && matchSearch;
        });

        // Sort by Exam then Number
        filtered.sort((a,b) => a.studentNo - b.studentNo);

        filtered.forEach(s => {
            tbody.innerHTML += `
            <tr>
                <td><input type="checkbox" class="admin-chk" value="${s.id}"></td>
                <td>${s.studentNo}</td>
                <td>${s.tc}</td>
                <td>${s.studentName}</td>
                <td>${s.examName}</td>
                <td>${s.examDate} ${s.examTime}</td>
                <td>
                    <button class="btn btn-sm btn-info" onclick="printSingleCard('${s.id}')"><i class="fas fa-print"></i></button>
                    <button class="btn btn-sm btn-warning" onclick="editStudent('${s.id}')"><i class="fas fa-edit"></i></button>
                </td>
            </tr>`;
        });
    }

    // --- ADMIN ACTIONS ---
    window.toggleSelectAll = () => {
        const master = document.getElementById('selectAll').checked;
        document.querySelectorAll('.admin-chk').forEach(c => c.checked = master);
    }

    window.adminQuickRegister = () => {
        Swal.fire({
            title: "Hızlı Kayıt",
            text: "Kayıt sihirbazına yönlendiriliyorsunuz...",
            timer: 1500,
            showConfirmButton: false
        }).then(() => startNewRegistration());
    }

    window.bulkDelete = async () => {
        const checked = Array.from(document.querySelectorAll('.admin-chk:checked')).map(c => c.value);
        if(checked.length === 0) return Swal.fire("Uyarı", "Seçili öğrenci yok", "warning");

        const res = await Swal.fire({
            title: `${checked.length} kaydı silmek üzeresiniz?`,
            text: "Bu işlem geri alınamaz!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Evet, Sil'
        });

        if(res.isConfirmed) {
            const updates = {};
            checked.forEach(id => updates[`bursluluk/students/${id}`] = null);
            await update(ref(db), updates);
            Swal.fire("Silindi", "Seçilenler silindi", "success");
            fetchAdminData();
        }
    }

    // Print Logic
    window.printSingleCard = (id) => {
        const s = dbStudents.find(x => x.id === id);
        const card = generateCardHTML(s);
        const printArea = document.getElementById('printArea');
        printArea.innerHTML = `<div style="display:flex; justify-content:center; margin-top:50px;">${card}</div>`;
        window.print();
        printArea.innerHTML = ""; 
    }

    window.printBulkCards = () => {
        const checked = Array.from(document.querySelectorAll('.admin-chk:checked')).map(c => c.value);
        if(checked.length === 0) return Swal.fire("Uyarı", "Listeden basılacak kişileri seçiniz.", "warning");
        
        const selectedStudents = dbStudents.filter(s => checked.includes(s.id));
        
        let html = '<div class="print-grid">';
        selectedStudents.forEach(s => {
            html += `<div style="border:1px dashed #ccc;">${generateCardHTML(s)}</div>`;
        });
        html += '</div>';
        
        const printArea = document.getElementById('printArea');
        printArea.innerHTML = html;
        window.print();
        printArea.innerHTML = "";
    }

    window.printList = () => {
        const checked = Array.from(document.querySelectorAll('.admin-chk:checked')).map(c => c.value);
        let list = checked.length > 0 ? dbStudents.filter(s => checked.includes(s.id)) : dbStudents; 
        
        let html = `
        <h3 style="text-align:center;">Fenomen Eğitim Kurumları - Sınav Listesi</h3>
        <table style="width:100%; border-collapse:collapse; font-size:12px;" border="1">
            <thead>
                <tr style="background:#eee;">
                    <th>No</th><th>TC</th><th>Ad Soyad</th><th>Okul</th><th>Telefon</th><th>Sınav/Seans</th>
                </tr>
            </thead>
            <tbody>
        `;
        list.forEach(s => {
            html += `<tr>
                <td>${s.studentNo}</td>
                <td>${s.tc}</td>
                <td>${s.studentName}</td>
                <td>${s.school}</td>
                <td>${s.phone1}</td>
                <td>${s.examName} (${s.examTime})</td>
            </tr>`;
        });
        html += '</tbody></table>';

        const printArea = document.getElementById('printArea');
        printArea.innerHTML = html;
        window.print();
        printArea.innerHTML = "";
    }

    window.editStudent = async (id) => {
        const s = dbStudents.find(x => x.id === id);
        const { value: formValues } = await Swal.fire({
            title: 'Öğrenci Düzenle',
            html:
                `<input id="swal-name" class="swal2-input" value="${s.studentName}" placeholder="Ad Soyad">` +
                `<input id="swal-phone" class="swal2-input" value="${s.phone1}" placeholder="Telefon">` +
                `<input id="swal-school" class="swal2-input" value="${s.school}" placeholder="Okul">`,
            focusConfirm: false,
            preConfirm: () => {
                return {
                    studentName: document.getElementById('swal-name').value,
                    phone1: document.getElementById('swal-phone').value,
                    school: document.getElementById('swal-school').value
                }
            }
        });

        if (formValues) {
            await update(ref(db, `bursluluk/students/${id}`), formValues);
            Swal.fire('Güncellendi', '', 'success');
            fetchAdminData();
        }
    }

    // Needed for module scope access
    import { push as fbPush } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";
    
    // Initial Load - Silent
    fetchExamData(false);

</script>

</body>
</html>
