<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fenomen Eğitim Kurumları – Bursluluk/LGS Başvuru</title>
    <!-- Bootstrap CSS for modern UI -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <style>
        /* General page styling */
        body {
            background-color: #f8f9fa;
            font-family: Arial, sans-serif;
            margin: 0;
            padding-top: 40px;
        }
        h1, h2 {
            text-align: center;
            margin-bottom: 20px;
        }
        .main-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 40px;
        }
        .main-buttons .btn {
            width: 220px;
            height: 80px;
            font-size: 20px;
            font-weight: bold;
        }
        /* Wizard styling */
        .wizard-step {
            display: none;
        }
        .wizard-step.active {
            display: block;
        }
        /* Entry card styling */
        .entry-card {
            border: 1px solid #343a40;
            padding: 15px;
            margin-top: 15px;
            border-radius: 8px;
            max-width: 400px;
            background-color: #fff;
        }
        .entry-card h5 {
            text-align: center;
            margin-bottom: 10px;
            font-weight: bold;
        }
        .entry-card div {
            margin-bottom: 5px;
        }
        /* Admin table styles */
        .admin-table th, .admin-table td {
            font-size: 14px;
        }
        .cursor-pointer {
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Fenomen Eğitim Kurumları</h1>
        <h2>Bursluluk / LGS Prova Başvuru Sistemi</h2>
        <!-- Main Buttons -->
        <div class="main-buttons">
            <button id="btnNew" class="btn btn-primary">Yeni Kayıt</button>
            <button id="btnLookup" class="btn btn-secondary">Kayıtlı Bilgisi</button>
            <button id="btnAdmin" class="btn btn-warning">Yönetici Bölümü</button>
        </div>

        <!-- Wizard modal for new registration -->
        <div class="modal fade" id="wizardModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Yeni Başvuru</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
                    </div>
                    <div class="modal-body">
                        <div id="wizardSteps">
                            <!-- Step 1: Select Exam -->
                            <div id="step1" class="wizard-step">
                                <h5>Sınav Seçimi</h5>
                                <div class="mb-3">
                                    <label for="examSelect" class="form-label">Sınav</label>
                                    <select id="examSelect" class="form-select">
                                        <option value="">-- Sınav seçin --</option>
                                    </select>
                                </div>
                                <div id="sessionContainer" class="mb-3" style="display:none;">
                                    <label class="form-label">Seans ve Saat Seçimi</label>
                                    <div id="sessionOptions"></div>
                                    <small class="form-text text-muted">Kontenjan dolu olan seanslar seçilemez.</small>
                                </div>
                                <div class="d-flex justify-content-end">
                                    <button class="btn btn-primary" id="btnStep1Next" disabled>Devam</button>
                                </div>
                            </div>
                            <!-- Step 2: Confirmation and TC -->
                            <div id="step2" class="wizard-step">
                                <h5>Başvuru Onayı</h5>
                                <p id="examSummary" class="fw-bold"></p>
                                <p>Bu sınava başvurmak istediğinize emin misiniz?</p>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-secondary" id="btnStep2Cancel">Hayır</button>
                                    <button class="btn btn-primary" id="btnStep2Next">Evet</button>
                                </div>
                            </div>
                            <!-- Step 3: TC check -->
                            <div id="step3" class="wizard-step">
                                <h5>TC Kimlik Numarası Kontrolü</h5>
                                <div class="mb-3">
                                    <label for="tcInput" class="form-label">Öğrenci TC (11 haneli)</label>
                                    <input type="text" id="tcInput" class="form-control" maxlength="11" placeholder="TC Kimlik Numarası">
                                </div>
                                <div id="tcError" class="text-danger mb-2" style="display:none;"></div>
                                <div class="d-flex justify-content-end">
                                    <button class="btn btn-secondary" id="btnStep3Back">Geri</button>
                                    <button class="btn btn-primary ms-2" id="btnStep3Next">Devam</button>
                                </div>
                            </div>
                            <!-- Step 4: Student info entry -->
                            <div id="step4" class="wizard-step">
                                <h5>Öğrenci Bilgileri</h5>
                                <form id="studentForm">
                                    <div class="mb-3">
                                        <label class="form-label">Öğrenci Tam Adı</label>
                                        <input type="text" class="form-control" id="studentName" placeholder="Ad Soyad">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Okulu</label>
                                        <input type="text" class="form-control" id="studentSchool" placeholder="Okul Adı">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Veli Tam Adı</label>
                                        <input type="text" class="form-control" id="parentName" placeholder="Ad Soyad">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Telefon 1</label>
                                        <input type="text" class="form-control" id="phone1" placeholder="(5xx) xxx xx xx">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Telefon 2</label>
                                        <input type="text" class="form-control" id="phone2" placeholder="(5xx) xxx xx xx">
                                        <small class="form-text text-muted">Bilgilendirme telefon üzerinden yapılacaktır, lütfen doğru giriniz.</small>
                                    </div>
                                </form>
                                <div id="formError" class="text-danger mb-2" style="display:none;"></div>
                                <div class="d-flex justify-content-end">
                                    <button class="btn btn-secondary" id="btnStep4Back">Geri</button>
                                    <button class="btn btn-success ms-2" id="btnSubmit">Kaydet</button>
                                </div>
                            </div>
                            <!-- Step 5: Success -->
                            <div id="step5" class="wizard-step">
                                <h5>Başvuru Tamamlandı</h5>
                                <p class="text-success">Fenomen Çocuk Kulübü başvurunuz alınmıştır. Giriş kartınız basıma geçilmiştir, sınavdan 2 gün öncesine kadar teslim alabilirsiniz.</p>
                                <div id="entryCardPreview"></div>
                                <div class="d-flex justify-content-end mt-3">
                                    <button class="btn btn-primary" data-bs-dismiss="modal">Kapat</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Lookup modal -->
        <div class="modal fade" id="lookupModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-md modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Kayıtlı Bilgi Sorgulama</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
                    </div>
                    <div class="modal-body">
                        <div id="lookupStep1">
                            <p>Kayıt sorgulamak için TC kimlik numarası veya öğrenci numarasını girin.</p>
                            <div class="mb-3">
                                <label class="form-label">TC / Öğrenci No</label>
                                <input type="text" id="lookupInput" class="form-control" placeholder="TC veya öğrenci numarası">
                            </div>
                            <div class="d-flex justify-content-end">
                                <button class="btn btn-primary" id="btnLookupSearch">Ara</button>
                            </div>
                            <div id="lookupError" class="text-danger mt-2" style="display:none;"></div>
                        </div>
                        <div id="lookupResults" style="display:none;">
                            <h5>Başvurular</h5>
                            <ul id="resultList" class="list-group"></ul>
                            <div class="mt-3">
                                <button class="btn btn-secondary" id="btnLookupBack">Yeni Sorgu</button>
                            </div>
                        </div>
                        <div id="lookupCard" style="display:none;">
                            <h5>Başvuru Detayı</h5>
                            <div id="selectedCard"></div>
                            <div class="mt-3">
                                <button class="btn btn-danger" id="btnCancelExam">Sınava Girmekten Vazgeçtim</button>
                                <button class="btn btn-secondary ms-2" id="btnLookupHome">Geri</button>
                            </div>
                        </div>
                        <!-- Cancel modal inside lookup -->
                        <div id="cancelSection" style="display:none;">
                            <p>Lütfen kayıtlı tam adınızı ve ardından "sınav iptal" ifadesini yazınız.</p>
                            <div class="mb-3">
                                <input type="text" id="cancelInput" class="form-control" placeholder="Örn: Necla Sıza sınav iptal">
                            </div>
                            <div class="d-flex gap-2">
                                <button class="btn btn-secondary" id="btnCancelBack">İptal</button>
                                <button class="btn btn-danger" id="btnCancelConfirm">Onayla</button>
                            </div>
                            <div id="cancelError" class="text-danger mt-2" style="display:none;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin modal -->
        <div class="modal fade" id="adminModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-xl modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Yönetici Paneli</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
                    </div>
                    <div class="modal-body">
                        <!-- Admin login -->
                        <div id="adminLogin">
                            <p>Lütfen şifrenizi girin.</p>
                            <div class="mb-3">
                                <input type="password" id="adminPassword" class="form-control" placeholder="******">
                            </div>
                            <div class="d-flex justify-content-end">
                                <button class="btn btn-primary" id="btnAdminLogin">Giriş</button>
                            </div>
                            <div id="adminError" class="text-danger mt-2" style="display:none;"></div>
                        </div>
                        <!-- Admin dashboard -->
                        <div id="adminDashboard" style="display:none;">
                            <div class="d-flex justify-content-between mb-3">
                                <h5>Kayıtlı Öğrenciler</h5>
                                <div>
                                    <select id="filterExam" class="form-select d-inline" style="width:auto;">
                                        <option value="">Tüm Sınavlar</option>
                                    </select>
                                    <select id="filterSession" class="form-select d-inline" style="width:auto;">
                                        <option value="">Tüm Seanslar</option>
                                    </select>
                                </div>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-bordered admin-table">
                                    <thead>
                                        <tr>
                                            <th>Öğrenci No</th>
                                            <th>Öğrenci Adı</th>
                                            <th>TC</th>
                                            <th>Okulu</th>
                                            <th>Veli Adı</th>
                                            <th>Telefon 1</th>
                                            <th>Telefon 2</th>
                                            <th>Sınav</th>
                                            <th>Tarih</th>
                                            <th>Seans</th>
                                            <th>Saat</th>
                                        </tr>
                                    </thead>
                                    <tbody id="adminTableBody"></tbody>
                                </table>
                            </div>
                            <div class="mt-3">
                                <button class="btn btn-outline-primary" id="btnAdminRefresh">Tabloyu Yenile</button>
                            </div>
                            <!-- Admin actions placeholders -->
                            <div class="mt-4">
                                <h5>Yönetici İşlemleri</h5>
                                <p>Aşağıdaki işlemler için butonlar henüz tam olarak uygulanmamıştır. Bu şablon, istenen gelişmiş özelliklerin daha sonra eklenebilmesi için genişletilebilir niteliktedir.</p>
                                <div class="d-flex flex-wrap gap-2">
                                    <button class="btn btn-outline-success" disabled>Hızlı Öğrenci Kayıt</button>
                                    <button class="btn btn-outline-secondary" disabled>Toplu Öğrenci Çıktısı</button>
                                    <button class="btn btn-outline-info" disabled>Yoklama Listesi</button>
                                    <button class="btn btn-outline-warning" disabled>Tekli Kart Basımı</button>
                                    <button class="btn btn-outline-danger" disabled>Toplu Kart Basımı</button>
                                    <button class="btn btn-outline-dark" disabled>Öğrenci Kayıt Silme</button>
                                    <button class="btn btn-outline-primary" disabled>Kayıt Güncelleme</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Required scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <!-- Inputmask for TC and phone formatting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/inputmask/5.0.8/jquery.inputmask.min.js"></script>
    <!-- Firebase libraries -->
    <script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-database-compat.js"></script>
    <script>
        // Firebase configuration from user instructions
        const firebaseConfig = {
            apiKey: "AIzaSyAIzu6aNQstwQCdMWODyIwiaVVBm63OeGw",
            authDomain: "odevfeno.firebaseapp.com",
            databaseURL: "https://odevfeno-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "odevfeno",
            storageBucket: "odevfeno.firebasestorage.app",
            messagingSenderId: "662757516934",
            appId: "1:662757516934:web:0042188832f63deb6fd307",
            measurementId: "G-4Q99NQRB38"
        };
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // Global variables
        let exams = [];
        let selectedExam = null;
        let selectedSessionIndex = null;
        let selectedRecord = null; // for lookup / cancellation

        document.addEventListener('DOMContentLoaded', function() {
            // Initialize input masks
            $("#tcInput").inputmask("99999999999");
            $("#phone1, #phone2").inputmask({mask: "(599) 999 99 99"});

            // Load exam data from Google Sheets
            loadExamData();

            // Event bindings for main buttons
            document.getElementById('btnNew').addEventListener('click', openWizard);
            document.getElementById('btnLookup').addEventListener('click', openLookup);
            document.getElementById('btnAdmin').addEventListener('click', openAdmin);

            // Wizard navigation
            document.getElementById('btnStep1Next').addEventListener('click', goToStep2);
            document.getElementById('btnStep2Cancel').addEventListener('click', function(){ closeModal('wizardModal'); });
            document.getElementById('btnStep2Next').addEventListener('click', function(){ showStep('step3'); });
            document.getElementById('btnStep3Back').addEventListener('click', function(){ showStep('step2'); });
            document.getElementById('btnStep3Next').addEventListener('click', handleTCCheck);
            document.getElementById('btnStep4Back').addEventListener('click', function(){ showStep('step3'); });
            document.getElementById('btnSubmit').addEventListener('click', submitRegistration);

            // Lookup events
            document.getElementById('btnLookupSearch').addEventListener('click', lookupRecord);
            document.getElementById('btnLookupBack').addEventListener('click', function(){ resetLookup(); });
            document.getElementById('btnLookupHome').addEventListener('click', function(){ showLookupList(); });
            document.getElementById('btnCancelExam').addEventListener('click', function(){ showCancelSection(); });
            document.getElementById('btnCancelBack').addEventListener('click', function(){ hideCancelSection(); });
            document.getElementById('btnCancelConfirm').addEventListener('click', confirmCancellation);

            // Admin events
            document.getElementById('btnAdminLogin').addEventListener('click', adminLogin);
            document.getElementById('btnAdminRefresh').addEventListener('click', loadAdminData);
        });

        /**
         * Fetch exam information from the Google Sheet and populate exam selector.
         * The sheet is expected to have columns: Sinav, Tarih, Seans, Kontenjan, Saatler, İlk numara
         */
        function loadExamData() {
            const sheetUrl = 'https://docs.google.com/spreadsheets/d/1oJGMO7FOPV4U86peeA63lmMk-wVCKsfWuyw2yefMweg/gviz/tq?tqx=out:csv&sheet=Bursluluk-Lgs';
            fetch(sheetUrl)
                .then(resp => resp.text())
                .then(csvText => {
                    const lines = csvText.trim().split('\n');
                    const headers = lines[0].split(',');
                    lines.slice(1).forEach(row => {
                        const cols = row.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/);
                        const exam = {
                            name: cols[0],
                            dates: cols[1].split(';'),
                            sessionCount: parseInt(cols[2]),
                            quotas: cols[3].split(';').map(x => parseInt(x)),
                            times: cols[4].split(';'),
                            startNumber: parseInt(cols[5])
                        };
                        exams.push(exam);
                    });
                    populateExamSelect();
                    populateAdminFilters();
                })
                .catch(err => {
                    console.error('Exam data load error', err);
                });
        }

        /**
         * Populate exam selection dropdown for new registration and admin filter.
         */
        function populateExamSelect() {
            const examSelect = document.getElementById('examSelect');
            exams.forEach((exam, idx) => {
                const opt = document.createElement('option');
                opt.value = idx;
                opt.textContent = exam.name;
                examSelect.appendChild(opt);
            });
            examSelect.addEventListener('change', function() {
                selectedExam = exams[this.value];
                selectedSessionIndex = null;
                renderSessionOptions();
            });
        }

        function populateAdminFilters() {
            const filterExam = document.getElementById('filterExam');
            exams.forEach((exam, idx) => {
                const opt = document.createElement('option');
                opt.value = exam.name;
                opt.textContent = exam.name;
                filterExam.appendChild(opt);
            });
            filterExam.addEventListener('change', function() {
                // re-render session filter based on selected exam
                const sessionSelect = document.getElementById('filterSession');
                sessionSelect.innerHTML = '<option value="">Tüm Seanslar</option>';
                const selectedName = this.value;
                const exam = exams.find(e => e.name === selectedName);
                if (exam) {
                    exam.times.forEach((time, idx) => {
                        const opt2 = document.createElement('option');
                        opt2.value = idx;
                        opt2.textContent = 'Seans ' + (idx+1) + ' (' + time + ')';
                        sessionSelect.appendChild(opt2);
                    });
                }
                loadAdminData();
            });
            document.getElementById('filterSession').addEventListener('change', loadAdminData);
        }

        /**
         * Render session choices based on selected exam and quota. Disabled if quota exhausted.
         */
        function renderSessionOptions() {
            const container = document.getElementById('sessionContainer');
            const optionsDiv = document.getElementById('sessionOptions');
            optionsDiv.innerHTML = '';
            if (!selectedExam) {
                container.style.display = 'none';
                document.getElementById('btnStep1Next').disabled = true;
                return;
            }
            // For each session fetch occupancy count from firebase
            // We'll compute available seats by subtracting count from quota
            const tasks = [];
            selectedExam.times.forEach((time, idx) => {
                tasks.push(new Promise(resolve => {
                    const ref = db.ref('bursluluk/' + selectedExam.name + '/' + idx);
                    ref.once('value', snapshot => {
                        const data = snapshot.val();
                        const count = data ? Object.keys(data).length : 0;
                        resolve({idx, count});
                    }, () => resolve({idx, count:0}));
                }));
            });
            Promise.all(tasks).then(results => {
                results.forEach(res => {
                    const available = selectedExam.quotas[res.idx] - res.count;
                    const radioId = 'session' + res.idx;
                    const div = document.createElement('div');
                    div.classList.add('form-check');
                    const radio = document.createElement('input');
                    radio.type = 'radio';
                    radio.name = 'sessionRadio';
                    radio.id = radioId;
                    radio.value = res.idx;
                    radio.classList.add('form-check-input');
                    if (available <= 0) {
                        radio.disabled = true;
                    }
                    const label = document.createElement('label');
                    label.htmlFor = radioId;
                    label.classList.add('form-check-label');
                    label.textContent = 'Seans ' + (res.idx+1) + ' – ' + selectedExam.times[res.idx] + ' (Kontenjan: ' + available + '/' + selectedExam.quotas[res.idx] + ')';
                    radio.addEventListener('change', function() {
                        selectedSessionIndex = parseInt(this.value);
                        document.getElementById('btnStep1Next').disabled = false;
                    });
                    div.appendChild(radio);
                    div.appendChild(label);
                    optionsDiv.appendChild(div);
                });
                container.style.display = 'block';
                document.getElementById('btnStep1Next').disabled = true;
            });
        }

        /** Show wizard modal and start at step1 */
        function openWizard() {
            selectedExam = null;
            selectedSessionIndex = null;
            document.getElementById('examSelect').value = '';
            document.getElementById('sessionContainer').style.display = 'none';
            document.getElementById('btnStep1Next').disabled = true;
            showStep('step1');
            const modal = new bootstrap.Modal(document.getElementById('wizardModal'));
            modal.show();
        }

        function goToStep2() {
            // prepare summary
            const date = selectedExam.dates[selectedSessionIndex] || selectedExam.dates[0];
            const time = selectedExam.times[selectedSessionIndex];
            document.getElementById('examSummary').textContent = `${selectedExam.name} – ${date} – ${time}`;
            showStep('step2');
        }

        /** Show specific step in wizard */
        function showStep(stepId) {
            document.querySelectorAll('#wizardSteps .wizard-step').forEach(el => el.classList.remove('active'));
            document.getElementById(stepId).classList.add('active');
        }

        function closeModal(modalId) {
            const modalEl = document.getElementById(modalId);
            const modalInstance = bootstrap.Modal.getInstance(modalEl);
            modalInstance.hide();
        }

        /**
         * Check if the TC number is valid and if there is an existing application.
         */
        function handleTCCheck() {
            const tc = document.getElementById('tcInput').value.trim();
            const errorDiv = document.getElementById('tcError');
            errorDiv.style.display = 'none';
            if (!/^[0-9]{11}$/.test(tc)) {
                errorDiv.textContent = 'TC numarası 11 haneli sayısal olmalıdır.';
                errorDiv.style.display = 'block';
                return;
            }
            // Check duplicate
            const ref = db.ref('bursluluk/' + selectedExam.name + '/' + selectedSessionIndex);
            ref.once('value', snapshot => {
                const data = snapshot.val();
                let exists = false;
                if (data) {
                    Object.values(data).forEach(rec => {
                        if (rec.tc === tc) {
                            exists = true;
                        }
                    });
                }
                if (exists) {
                    errorDiv.textContent = 'Bu sınav için daha önce başvurunuz alınmıştır.';
                    errorDiv.style.display = 'block';
                } else {
                    showStep('step4');
                }
            });
        }

        /**
         * Validate form and submit registration to Firebase.
         */
        function submitRegistration() {
            const studentName = document.getElementById('studentName').value.trim();
            const studentSchool = document.getElementById('studentSchool').value.trim();
            const parentName = document.getElementById('parentName').value.trim();
            const phone1 = document.getElementById('phone1').value.trim();
            const phone2 = document.getElementById('phone2').value.trim();
            const tc = document.getElementById('tcInput').value.trim();
            const errorDiv = document.getElementById('formError');
            errorDiv.style.display = 'none';
            // Validation
            if (studentName.split(' ').length < 2) {
                errorDiv.textContent = 'Öğrenci tam adı en az iki kelime olmalıdır.';
                errorDiv.style.display = 'block';
                return;
            }
            if (parentName.split(' ').length < 2) {
                errorDiv.textContent = 'Veli tam adı en az iki kelime olmalıdır.';
                errorDiv.style.display = 'block';
                return;
            }
            if (!studentSchool) {
                errorDiv.textContent = 'Okul adı girilmelidir.';
                errorDiv.style.display = 'block';
                return;
            }
            if (phone1.length < 10) {
                errorDiv.textContent = 'Telefon 1 geçerli bir numara olmalıdır.';
                errorDiv.style.display = 'block';
                return;
            }
            // assign student number
            const ref = db.ref('bursluluk/' + selectedExam.name + '/' + selectedSessionIndex);
            ref.once('value', snapshot => {
                const data = snapshot.val() || {};
                let usedNumbers = [];
                Object.values(data).forEach(rec => {
                    usedNumbers.push(rec.studentNumber);
                });
                usedNumbers.sort((a,b) => a-b);
                let nextNumber = selectedExam.startNumber;
                // find smallest available number
                for (;;) {
                    if (!usedNumbers.includes(nextNumber)) break;
                    nextNumber++;
                }
                const record = {
                    studentNumber: nextNumber,
                    studentName,
                    studentSchool,
                    parentName,
                    phone1,
                    phone2,
                    tc,
                    examName: selectedExam.name,
                    date: selectedExam.dates[selectedSessionIndex] || selectedExam.dates[0],
                    session: selectedSessionIndex + 1,
                    time: selectedExam.times[selectedSessionIndex]
                };
                // push to firebase
                const newRef = ref.push();
                newRef.set(record, err => {
                    if (err) {
                        errorDiv.textContent = 'Kayıt sırasında hata oluştu: ' + err;
                        errorDiv.style.display = 'block';
                    } else {
                        // show success and card
                        renderEntryCard(record, 'entryCardPreview');
                        showStep('step5');
                    }
                });
            });
        }

        /**
         * Render a mini student entry card in the given container.
         * @param {*} record object containing student data
         * @param {*} containerId html element id to append card
         */
        function renderEntryCard(record, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            const card = document.createElement('div');
            card.classList.add('entry-card');
            card.innerHTML = `
                <h5>Fenomen Çocuk Kulübü</h5>
                <div><strong>Öğrenci Adı:</strong> ${record.studentName}</div>
                <div><strong>Okulu:</strong> ${record.studentSchool}</div>
                <div><strong>TC No:</strong> ${record.tc}</div>
                <div><strong>Öğrenci No:</strong> ${record.studentNumber}</div>
                <div><strong>Sınav:</strong> ${record.examName}</div>
                <div><strong>Tarih:</strong> ${record.date}</div>
                <div><strong>Seans Saati:</strong> ${record.time}</div>
                <div><strong>Yer:</strong> Fenomen Çocuk Kulübü</div>
            `;
            container.appendChild(card);
        }

        /** Open lookup modal */
        function openLookup() {
            resetLookup();
            const modal = new bootstrap.Modal(document.getElementById('lookupModal'));
            modal.show();
        }

        /** Reset lookup modal to initial state */
        function resetLookup() {
            document.getElementById('lookupStep1').style.display = 'block';
            document.getElementById('lookupResults').style.display = 'none';
            document.getElementById('lookupCard').style.display = 'none';
            document.getElementById('cancelSection').style.display = 'none';
            document.getElementById('lookupInput').value = '';
            document.getElementById('lookupError').style.display = 'none';
        }

        /** Lookup records by TC or student number */
        function lookupRecord() {
            const query = document.getElementById('lookupInput').value.trim();
            const errorDiv = document.getElementById('lookupError');
            errorDiv.style.display = 'none';
            if (!query) {
                errorDiv.textContent = 'TC veya öğrenci numarası girin.';
                errorDiv.style.display = 'block';
                return;
            }
            // Search across all exams and sessions
            const tasks = [];
            exams.forEach(exam => {
                exam.times.forEach((time, idx) => {
                    tasks.push(new Promise(resolve => {
                        db.ref('bursluluk/' + exam.name + '/' + idx).once('value', snapshot => {
                            const data = snapshot.val();
                            if (data) {
                                Object.entries(data).forEach(([key, rec]) => {
                                    if (rec.tc === query || rec.studentNumber.toString() === query) {
                                        resolve({key, rec});
                                    }
                                });
                            }
                            resolve(null);
                        }, () => resolve(null));
                    }));
                });
            });
            Promise.all(tasks).then(results => {
                const found = results.filter(x => x); 
                if (found.length === 0) {
                    errorDiv.textContent = 'Girilen numara ile bir başvuru bulunamadı.';
                    errorDiv.style.display = 'block';
                    return;
                }
                // Show list of results (most users will have one)
                document.getElementById('lookupStep1').style.display = 'none';
                const resultList = document.getElementById('resultList');
                resultList.innerHTML = '';
                found.forEach(item => {
                    const li = document.createElement('li');
                    li.classList.add('list-group-item', 'cursor-pointer');
                    li.textContent = item.rec.examName + ' – ' + item.rec.date + ' – Seans ' + item.rec.session;
                    li.addEventListener('click', function(){
                        selectedRecord = item;
                        showSelectedCard();
                    });
                    resultList.appendChild(li);
                });
                document.getElementById('lookupResults').style.display = 'block';
            });
        }

        /** Show selected record card */
        function showSelectedCard() {
            document.getElementById('lookupResults').style.display = 'none';
            document.getElementById('lookupCard').style.display = 'block';
            renderEntryCard(selectedRecord.rec, 'selectedCard');
        }

        function showLookupList() {
            document.getElementById('lookupCard').style.display = 'none';
            document.getElementById('lookupResults').style.display = 'block';
        }

        /** Cancel exam section show/hide */
        function showCancelSection() {
            document.getElementById('cancelSection').style.display = 'block';
            document.getElementById('lookupCard').style.display = 'none';
            document.getElementById('cancelInput').value = '';
            document.getElementById('cancelError').style.display = 'none';
        }
        function hideCancelSection() {
            document.getElementById('cancelSection').style.display = 'none';
            document.getElementById('lookupCard').style.display = 'block';
        }

        /** Confirm cancellation: verify typed text and delete record from Firebase */
        function confirmCancellation() {
            const userInput = document.getElementById('cancelInput').value.trim().toLowerCase();
            const expected = `${selectedRecord.rec.studentName.toLowerCase()} sınav iptal`;
            const errorDiv = document.getElementById('cancelError');
            errorDiv.style.display = 'none';
            if (userInput !== expected) {
                errorDiv.textContent = 'Lütfen tam adınızı ve "sınav iptal" ifadesini doğru yazınız.';
                errorDiv.style.display = 'block';
                return;
            }
            // Confirmation
            if (!confirm('Bu işlem geri alınamaz. Onaylıyor musunuz?')) {
                return;
            }
            // Remove from database
            const rec = selectedRecord.rec;
            const exam = rec.examName;
            const sessionIndex = rec.session - 1;
            // Find firebase key by comparing TC and student number
            db.ref('bursluluk/' + exam + '/' + sessionIndex).once('value', snapshot => {
                const data = snapshot.val();
                if (data) {
                    Object.entries(data).forEach(([key, value]) => {
                        if (value.tc === rec.tc && value.studentNumber === rec.studentNumber) {
                            db.ref('bursluluk/' + exam + '/' + sessionIndex + '/' + key).remove(() => {
                                alert('Kayıt başarıyla silindi.');
                                hideCancelSection();
                                closeModal('lookupModal');
                            });
                        }
                    });
                }
            });
        }

        /** Open admin panel */
        function openAdmin() {
            document.getElementById('adminPassword').value = '';
            document.getElementById('adminError').style.display = 'none';
            document.getElementById('adminLogin').style.display = 'block';
            document.getElementById('adminDashboard').style.display = 'none';
            const modal = new bootstrap.Modal(document.getElementById('adminModal'));
            modal.show();
        }

        /** Admin login check */
        function adminLogin() {
            const pwd = document.getElementById('adminPassword').value;
            const errorDiv = document.getElementById('adminError');
            errorDiv.style.display = 'none';
            // Hardcoded password hashed (simple) – for demonstration only
            if (pwd !== '13579') {
                errorDiv.textContent = 'Yanlış şifre.';
                errorDiv.style.display = 'block';
                return;
            }
            document.getElementById('adminLogin').style.display = 'none';
            document.getElementById('adminDashboard').style.display = 'block';
            loadAdminData();
        }

        /** Load all records for admin table with optional filters */
        function loadAdminData() {
            const filterExam = document.getElementById('filterExam').value;
            const filterSession = document.getElementById('filterSession').value;
            const tbody = document.getElementById('adminTableBody');
            tbody.innerHTML = '';
            const tasks = [];
            exams.forEach(exam => {
                if (filterExam && exam.name !== filterExam) return;
                exam.times.forEach((time, idx) => {
                    if (filterSession && idx.toString() !== filterSession) return;
                    tasks.push(new Promise(resolve => {
                        db.ref('bursluluk/' + exam.name + '/' + idx).once('value', snapshot => {
                            const data = snapshot.val();
                            if (data) {
                                Object.values(data).forEach(rec => {
                                    const tr = document.createElement('tr');
                                    tr.innerHTML = `
                                        <td>${rec.studentNumber}</td>
                                        <td>${rec.studentName}</td>
                                        <td>${rec.tc}</td>
                                        <td>${rec.studentSchool}</td>
                                        <td>${rec.parentName}</td>
                                        <td>${rec.phone1}</td>
                                        <td>${rec.phone2}</td>
                                        <td>${rec.examName}</td>
                                        <td>${rec.date}</td>
                                        <td>${rec.session}</td>
                                        <td>${rec.time}</td>
                                    `;
                                    tbody.appendChild(tr);
                                });
                            }
                            resolve();
                        }, () => resolve());
                    }));
                });
            });
            Promise.all(tasks).then(() => {
                // all rows loaded
            });
        }
    </script>
</body>
</html>